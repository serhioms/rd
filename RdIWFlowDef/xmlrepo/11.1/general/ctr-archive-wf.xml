<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- $Id: ctr-archive-wf.xml 4168 2016-06-23 19:16:47Z gmusial $
	 Maestro version: 1.16.0 -->
	
<workflow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="workflowDefinition.xsd">
	<name>ctr-archive-wf</name> 
  	<externalWorkflowCode>ctr-archive-wf</externalWorkflowCode> 
  	<finishOrchestrationASAPOnError>false</finishOrchestrationASAPOnError> 
	<description>ctr-archive-wf ($LastChangedRevision: 4168 $)</description>
	
	<properties>
		<generalProperties>
			<property name="RUN-ENV">${MAESTRO_RUN_ENV}</property>
		</generalProperties>
	</properties>
	
	<sequential name="CTR-ARCHIVE" id="CTR-ARCHIVE">
	<externalWorkflowReference name="CM-CLEANUP-CSM-WF"	id="CM-CLEANUP-CSM-WF">
		<externalWorkflowCode>CM-CLEANUP-CSM-WF</externalWorkflowCode>
		<inputProperties>
			<property name="CTR-SOURCE-SYSTEM-CODE">CSM</property>
			<property name="RUN-INSTANCE">1</property>
		</inputProperties>
	</externalWorkflowReference>
		<stage name="GET-BUSINESS-DATE" id="GET-BUSINESS-DATE">
			<description>Retrieve the business date</description>
			<stageFailure>
				<failureCondition><![CDATA['${GET-BUSINESS-DATE.result}' == 'INSTANCE NAME NO FOUND']]></failureCondition>
				<failureMessage>GET-BUSINESS-DATE returned: INSTANCE NAME NOT FOUND</failureMessage>
			</stageFailure>
			<execDefinition>
				<dbFunction name="CTRMSO.GET_CONFIG_BUSINESS_DATE_FN">
					<in>
						<param name="P_INSTANCE_NAME_I" type="STRING">${CONFIG_INSTANCE_NAME}</param>
					</in>
					<result name="result" type="STRING"></result>
				</dbFunction>
			</execDefinition>
		</stage>
		
		<stage name="FORMAT-BUSINESS-DATE" id="FORMAT-BUSINESS-DATE">
			<description>Format the business date</description>
			<stageFailure>
				<failureCondition><![CDATA['${FORMAT-BUSINESS-DATE.result}' == '']]></failureCondition>
				<failureMessage>FORMAT-BUSINESS-DATE returned empty date</failureMessage>
			</stageFailure>
			<execDefinition>
				<dbFunction name="CTRMSO.FORMAT_DATE_FN">
					<in>
						<param name="DATE_I" type="STRING">${GET-BUSINESS-DATE.result}</param>
						<param name="FORMAT_I" type="STRING">yyyymmdd</param>
					</in>
					<result name="result" type="STRING"></result>
				</dbFunction>
			</execDefinition>
		</stage>
		<stage name="ARCHIVE-LANDING-TABLES" id="ARCHIVE-LANDING-TABLES">
			<description>Archives all landing tables without truncating them - copies data from _L to _L_A tables</description>
			<execDefinition>
				<dbProcedure name="CTRMSO.ARCHIVE_ALL_LANDING_TABLE_SP">
					<in></in>
					<out></out>
				</dbProcedure>
			</execDefinition>
		</stage>
		<stage name="CLEAN-OLD-ARCHIVE-FILES" id="CLEAN-OLD-ARCHIVE-FILES">
			<description>Cleanup old archive files</description>
			<stageFailure>
				<failureCondition><![CDATA[${CLEAN-OLD-ARCHIVE-FILES.exitCode} != 0]]></failureCondition>
				<failureMessage>CTR-(${CLEAN-OLD-ARCHIVE-FILES.exitCode}) : Error while archiving files. See CTR log for details.</failureMessage>
			</stageFailure>
			<execDefinition>
				<callExternalProcess>
					<commandLine>${CTR_APP_ROOT_PATH}/script/ctrcleanup_archive.${SHELL_SCRIPT_EXTENSION}</commandLine>
					<workingDirectory>${CTR_APP_ROOT_PATH}/script/</workingDirectory>
					<exitCodeProperty>exitCode</exitCodeProperty>
				</callExternalProcess>
			</execDefinition>
		</stage>
		
		<stage name="ARCHIVE-FILES" id="ARCHIVE-FILES">
			<description>Archive and cleanup files</description>
			<stageFailure>
				<failureCondition><![CDATA[${ARCHIVE-FILES.exitCode} != 0]]></failureCondition>
				<failureMessage>CTR-(${ARCHIVE-FILES.exitCode}) : Error while archiving files. See CTR log for details.</failureMessage>
			</stageFailure>
			<execDefinition>
				<callExternalProcess>
					<commandLine>${CTR_APP_ROOT_PATH}/script/ctrarchv.${SHELL_SCRIPT_EXTENSION} ${GET-BUSINESS-DATE.result}</commandLine>
					<workingDirectory>${CTR_APP_ROOT_PATH}/script/</workingDirectory>
					<exitCodeProperty>exitCode</exitCodeProperty>
				</callExternalProcess>
			</execDefinition>
		</stage>
		

	</sequential>
</workflow>