<?xml version="1.0" encoding="UTF-8"?>
<workflow
    xsi:noNamespaceSchemaLocation="http://localhost:8080/maestro-orch-web/schemas/workflowdefn/workflowDefinition.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <name>set-business-date-wf</name>
    <externalWorkflowCode>set-business-date-wf</externalWorkflowCode>
    <finishOrchestrationASAPOnError>false</finishOrchestrationASAPOnError>
    <description>set-business-date-wf ($LastChangedRevision: 4168 $)</description>
    <properties>
        <inputProperties>
            <property name="BUSINESS-DATE">DD-MMM-YY</property>
        </inputProperties>
        <generalProperties>
            <property name="WF-EOD-EOM-INDICATOR">D</property>
			<property name="RUN-INSTANCE">1</property>
			<property name="ROOT-WF-ID">set-business-date-wf</property>
			<property name="WORKFLOW_RUN_ID">0</property>
        </generalProperties>
    </properties>
    <sequential id="CTR-ROLL-BPD" name="CTR-ROLL-BPD">
        <externalWorkflowReference name="INITIALIZE-RUN" id="INITIALIZE-RUN">
			<externalWorkflowCode>INITIALIZE-RUN</externalWorkflowCode>
			<inputProperties>
				<property name="EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
				<property name="SOURCE-SYSTEM">-1</property>
				<property name="ROOT-WF-ID">${ROOT-WF-ID}</property>
				<property name="TARGET-SYSTEM"></property>
				<property name="RUN-TYPE" />
				<property name="RUN-INSTANCE">${RUN-INSTANCE}</property>
				<property name="WORKFLOW-RUN-ID">${WORKFLOW_RUN_ID}</property>
			</inputProperties>
			<outputPropertyMapping>
				<mapping source="BUSINESS-DATE" target="BUSINESS-DATE"/>
				<mapping source="BUSINESS-DATE-FORMATTED" target="BUSINESS-DATE-FORMATTED"/>
				<mapping source="RUN-ID" target="P_RUN_ID_O"/>
				<mapping source="IS-MONTH-END" target="IS-MONTH-END"/>
			</outputPropertyMapping>
		</externalWorkflowReference>
        <stage id="GET-NEXT-BUSINESS-DATE" name="GET-NEXT-BUSINESS-DATE">
            <description>Get the next business date</description>
            <skipCondition>'${BUSINESS-DATE}' != 'NEXT-DAY'</skipCondition>
            <execDefinition>
                <dbFunction name="CTRMSO.GET_NEXT_BUSINESS_DATE_FN">
                    <in>
                        <param name="P_BUSINESS_DATE_I" type="STRING">${INITIALIZE-RUN.BUSINESS-DATE}</param>
                    </in>
                    <result name="result" type="STRING"/>
                </dbFunction>
            </execDefinition>
        </stage>
        <stage id="SET-NEXT-DAY-BUSINESS-DATE" name="SET-NEXT-DAY-BUSINESS-DATE">
            <description>Set the new business date</description>
            <skipCondition>'${BUSINESS-DATE}' != 'NEXT-DAY'</skipCondition>
            <execDefinition>
                <dbProcedure name="CTRMSO.SET_BUSINESS_DATE_SP">
                    <in>
                        <param name="P_INSTANCE_NAME_I" type="STRING">${CONFIG_INSTANCE_NAME}</param>
                        <param name="P_RUN_ID_I" type="NUMBER">${INITIALIZE-RUN.P_RUN_ID_O}</param>
                        <param name="P_STAGE_ID_I" type="STRING">PREPARE</param>
                        <param name="P_TASK_ID_I" type="STRING">SET-BUSINESS-DATE</param>
                        <param name="P_LOG_ID_I" type="STRING">1</param>
                        <param name="P_BUSINESS_DATE_I" type="STRING">${GET-NEXT-BUSINESS-DATE.result}</param>
                    </in>
                    <out>
                        <param name="P_RET_VALUE_O" type="NUMBER"/>
                        <param name="P_RET_MESSAGE_O" type="STRING"/>
                    </out>
                </dbProcedure>
            </execDefinition>
        </stage>
        <stage id="SET-BUSINESS-DATE" name="SET-BUSINESS-DATE">
            <description>Set the new business date</description>
            <skipCondition>'${BUSINESS-DATE}' == 'NEXT-DAY' || '${BUSINESS-DATE}' == 'NEXT-MONTH'</skipCondition>
            <execDefinition>
                <dbProcedure name="CTRMSO.SET_BUSINESS_DATE_SP">
                    <in>
                        <param name="P_INSTANCE_NAME_I" type="STRING">${CONFIG_INSTANCE_NAME}</param>
                        <param name="P_RUN_ID_I" type="NUMBER">${INITIALIZE-RUN.P_RUN_ID_O}</param>
                        <param name="P_STAGE_ID_I" type="STRING">PREPARE</param>
                        <param name="P_TASK_ID_I" type="STRING">SET-BUSINESS-DATE</param>
                        <param name="P_LOG_ID_I" type="STRING">1</param>
                        <param name="P_BUSINESS_DATE_I" type="STRING">${BUSINESS-DATE}</param>
                    </in>
                    <out>
                        <param name="P_RET_VALUE_O" type="NUMBER"/>
                        <param name="P_RET_MESSAGE_O" type="STRING"/>
                    </out>
                </dbProcedure>
            </execDefinition>
        </stage>
        <stage id="GET-UPDATED-BUSINESS-DATE" name="GET-UPDATED-BUSINESS-DATE">
            <description>Retrieve the business date</description>
            <stageFailure>
                <failureCondition>'${GET-UPDATED-BUSINESS-DATE.result}' == 'INSTANCE NAME NO FOUND'</failureCondition>
                <failureMessage>GET-UPDATED-BUSINESS-DATE returned: INSTANCE NAME NOT FOUND</failureMessage>
            </stageFailure>
            <execDefinition>
                <dbFunction name="CTRMSO.GET_CONFIG_BUSINESS_DATE_FN">
                    <in>
                        <param name="P_INSTANCE_NAME_I" type="STRING">${CONFIG_INSTANCE_NAME}</param>
                    </in>
                    <result name="result" type="STRING"/>
                </dbFunction>
            </execDefinition>
        </stage>
        
        <externalWorkflowReference name="FINALIZE-RUN" id="COMPLETE-RUN">
			<description>Finalize the run and mark complete</description>
			<externalWorkflowCode>FINALIZE-RUN</externalWorkflowCode>
			<inputProperties>
				<property name="SOURCE-SYSTEM">NONE</property>
				<property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
				<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
				<property name="SRC-FILE-SUFFIX-PATTERN">NONE</property>
				<property name="FTP-SOURCE-DIR">NONE</property>
			</inputProperties>
		</externalWorkflowReference>
    </sequential>
</workflow>
