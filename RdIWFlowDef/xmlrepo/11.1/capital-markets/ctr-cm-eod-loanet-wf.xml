<?xml version="1.0" encoding="UTF-8"?>
<workflow
    xsi:noNamespaceSchemaLocation="workflowDefinition.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <name>ctr-cm-eod-loanet-wf</name>
    <externalWorkflowCode>ctr-cm-eod-loanet-wf</externalWorkflowCode>
    <finishOrchestrationASAPOnError>false</finishOrchestrationASAPOnError>
    <description>ctr-cm-eod-loanet-wf ($LastChangedRevision: 4311 $)</description>
    <properties>
        <inputProperties>
            <property name="WF-EOD-EOM-INDICATOR">D</property>
			<property name="RUN-INSTANCE">1</property>
            <property name="LOANET_START_TIME_PATTERN">[@START[&lt;ENTER_TIME 24HHMM&gt;]]</property>
        </inputProperties>
        <generalProperties>
        	<property name="WORKFLOW_RUN_ID">0</property>
            <property name="DATA-CATEGORY-TYPE">CM</property>
            <property name="FTP-SOURCE-DIR">loanet/inbox</property>
			<property name="FUNDTRACKER-FTP-SRC-DIR">fundtracker/inbox</property>
			<property name="DATA-NOTLOAD-DIR">${CTR_DATA_ROOT_PATH}/data_in/infiles/not_load</property>
            <property name="HOLDING-DIR">${CTR_DATA_ROOT_PATH}/manual/loanet</property>
            <property name="HOLDING-MATCH-PATTERN">.+_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</property>
            <property name="REPLICATE-SRC-IF-MONTH-END">T</property>
            <property name="ROOT-WF-ID">ctr-cm-eod-loanet-wf</property>
            <property name="SQLLDR-CONTROL-DIRECTORY">sqlldr</property>
            <property name="SQLLDR-DISCARD-DIR">data_in/discard</property>
            <property name="SQLLDR-LOG-DIRECTORY">data_in/ldrlog</property>
            <property name="SQLLDR-PROCESSING-SOURCE-DIR">data_in/infiles</property>
            <property name="SQLLDR-REJECT-DIRECTORY">data_in/reject</property>
            <property name="SRC-FILE-FILETYPE-PATTERN"/>
            <property name="SRC-FILE-FREQUENCY-PATTERN">${WF-EOD-EOM-INDICATOR}_</property>
            <property name="SRC-FILE-PRODUCTTYPE-PATTERN">[^_]*[_]?</property>
            <property name="SRC-FILE-SUFFIX-PATTERN-1">${SRC-FILE-PRODUCTTYPE-PATTERN}${SRC-FILE-FILETYPE-PATTERN}${SRC-FILE-FREQUENCY-PATTERN}${SRC-FILE-VERSION-PATTERN}</property>
            <property name="SRC-FILE-SUFFIX-PATTERN-2">${SRC-FILE-PRODUCTTYPE-PATTERN}${SRC-FILE-FILETYPE-PATTERN}${SRC-FILE-FREQUENCY-PATTERN}(${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED})?_</property>
            <property name="SRC-FILE-VERSION-PATTERN">(${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED})?_[0-9]{3,3}</property>
        </generalProperties>
    </properties>
    <sequential id="CTR-CAPITAL-MARKETS" name="CTR-CAPITAL-MARKETS">
        <externalWorkflowReference id="INITIALIZE-RUN" name="INITIALIZE-RUN">
            <externalWorkflowCode>INITIALIZE-RUN</externalWorkflowCode>
            <inputProperties>
                <property name="EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
                <property name="SOURCE-SYSTEM">LOANET</property>
                <property name="ROOT-WF-ID">${ROOT-WF-ID}</property>
                <property name="TARGET-SYSTEM"/>
                <property name="RUN-TYPE" />
				<property name="RUN-INSTANCE">${RUN-INSTANCE}</property>
                <property name="WORKFLOW-RUN-ID">${WORKFLOW_RUN_ID}</property>
            </inputProperties>
            <outputPropertyMapping>
                <mapping source="RUN-ID" target="P_RUN_ID_O"/>
                <mapping source="IS-MONTH-END" target="IS-MONTH-END"/>
                <mapping source="BUSINESS-DATE-FORMATTED" target="BUSINESS-DATE-FORMATTED"/>
                <mapping source="BUSINESS-DATE" target="BUSINESS-DATE"/>
            </outputPropertyMapping>
        </externalWorkflowReference>
        <externalWorkflowReference id="PREPARE-SOURCE-FILES" name="PREPARE-SOURCE-FILES">
            <externalWorkflowCode>PREPARE-SOURCE-FILES</externalWorkflowCode>
            <inputProperties>
                <property name="FTP-SOURCE-DIR">${CTR_FTP_ROOT_PATH}/${FUNDTRACKER-FTP-SRC-DIR}</property>
                <property name="HOLDING-SOURCE-DIR">${HOLDING-DIR}</property>
                <property name="HOLDING-MATCH-PATTERN">${HOLDING-MATCH-PATTERN}</property>
                <property name="EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
                <property name="IS-MONTH-END">${INITIALIZE-RUN.IS-MONTH-END}</property>
            </inputProperties>
        </externalWorkflowReference>
		
		<stage enabled="true" id="ALDOP-FILEWATCH-WF" name="ALDOP-FILEWATCH-WF">
            <autoRetryConfiguration>
                <delayBetweenAttemptsInMs>60000</delayBetweenAttemptsInMs>
                <maximumNumberOfRetryAttempts>720</maximumNumberOfRetryAttempts>
                <maximumRetryDurationInMs>43200000</maximumRetryDurationInMs>
            </autoRetryConfiguration>
            <execDefinition>
                <pollingFileWatcher>
                    <watchedFiles>
                        <resource>
                            <uri>${LOANET_DESTINATION_URI_2}</uri>
                            <searchPattern>[@ALLOW_MF]${LOANET_START_TIME_PATTERN}AGD-134941099-.+-[0-9]{3,3}</searchPattern>
                            <matchedUriOutputProperty>AGD-134-FILE</matchedUriOutputProperty>
                        </resource>
                        <resource>
                            <uri>${LOANET_DESTINATION_URI}</uri>
                            <searchPattern>[@ALLOW_MF]${LOANET_START_TIME_PATTERN}AGD-135239583-.+-[0-9]{3,3}</searchPattern>
                            <matchedUriOutputProperty>AGD-135-FILE</matchedUriOutputProperty>
                        </resource>
                        <resource>
                            <uri>${LOANET_DESTINATION_URI_3}</uri>
                            <searchPattern>[@ALLOW_MF]${LOANET_START_TIME_PATTERN}AGD-980235062-.+-[0-9]{3,3}</searchPattern>
                            <matchedUriOutputProperty>AGD-980-FILE</matchedUriOutputProperty>
                        </resource>
                        <resource>
                            <uri>${LOANET_DESTINATION_URI_2}</uri>
                            <searchPattern>[@ALLOW_MF]${LOANET_START_TIME_PATTERN}AGN-134941099-.+-[0-9]{3,3}</searchPattern>
                            <matchedUriOutputProperty>AGN-134-FILE</matchedUriOutputProperty>
                        </resource>
                        <resource>
                            <uri>${LOANET_DESTINATION_URI}</uri>
                            <searchPattern>[@ALLOW_MF]${LOANET_START_TIME_PATTERN}AGN-135239583-.+-[0-9]{3,3}</searchPattern>
                            <matchedUriOutputProperty>AGN-135-FILE</matchedUriOutputProperty>
                        </resource>
                        <resource>
                            <uri>${LOANET_DESTINATION_URI_3}</uri>
                            <searchPattern>[@ALLOW_MF]${LOANET_START_TIME_PATTERN}AGN-980235062-.+-[0-9]{3,3}</searchPattern>
                            <matchedUriOutputProperty>AGN-980-FILE</matchedUriOutputProperty>
                        </resource>
						<resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FUNDTRACKER-FTP-SRC-DIR}</uri>
                            <searchPattern>fundtracker_ig_codes_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.csv</searchPattern>
                            <matchedUriOutputProperty>FUNDTRACKER-FILE</matchedUriOutputProperty>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FUNDTRACKER-FTP-SRC-DIR}</uri>
                            <searchPattern>fundtracker_ig_codes_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</searchPattern>
                            <matchedUriOutputProperty>FUNDTRACKER-FILE-MRK</matchedUriOutputProperty>
                        </resource>
                    </watchedFiles>
                    <matchedCountProperty>matchedCount</matchedCountProperty>
                    <allowFileNotFound>false</allowFileNotFound>
                </pollingFileWatcher>
            </execDefinition>
        </stage>
        
        <stage name="TRANSFER-ALDOP-FTP-FILES-TO-LOCAL" id="TRANSFER-ALDOP-FTP-FILES-TO-LOCAL">
			<description>Transfer files from SFTP directory to ftp directory</description>
			<skipCondition>'${ALDOP-FILEWATCH-WF.matchedCount}' == '0' </skipCondition>
			<execDefinition>
				<fileTransfer>
					<transfer>
						<sourceResource>
							<uri>${LOANET_DESTINATION_URI_2}</uri>
							<searchPattern>AGD-134941099-.+-[0-9]{3,3}</searchPattern>
						</sourceResource>
						<targetResource>
							<uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
							<matchedUriOutputProperty>CTR-AGD-134-FILE</matchedUriOutputProperty>
						</targetResource>
					</transfer>
					<transfer>
						<sourceResource>
							<uri>${LOANET_DESTINATION_URI}</uri>
							<searchPattern>AGD-135239583-.+-[0-9]{3,3}</searchPattern>
						</sourceResource>
						<targetResource>
							<uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
							<matchedUriOutputProperty>CTR-AGD-135-FILE</matchedUriOutputProperty>
						</targetResource>
					</transfer>
					<transfer>
						<sourceResource>
							<uri>${LOANET_DESTINATION_URI_3}</uri>
							<searchPattern>AGD-980235062-.+-[0-9]{3,3}</searchPattern>
						</sourceResource>
						<targetResource>
							<uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
							<matchedUriOutputProperty>CTR-AGD-980-FILE</matchedUriOutputProperty>
						</targetResource>
					</transfer>
					<transfer>
						<sourceResource>
							<uri>${LOANET_DESTINATION_URI_2}</uri>
							<searchPattern>AGN-134941099-.+-[0-9]{3,3}</searchPattern>
						</sourceResource>
						<targetResource>
							<uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
							<matchedUriOutputProperty>CTR-AGN-134-FILE</matchedUriOutputProperty>
						</targetResource>
					</transfer>
					<transfer>
						<sourceResource>
							<uri>${LOANET_DESTINATION_URI}</uri>
							<searchPattern>AGN-135239583-.+-[0-9]{3,3}</searchPattern>
						</sourceResource>
						<targetResource>
							<uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
							<matchedUriOutputProperty>CTR-AGN-135-FILE</matchedUriOutputProperty>
						</targetResource>
					</transfer>
					<transfer>
						<sourceResource>
							<uri>${LOANET_DESTINATION_URI_3}</uri>
							<searchPattern>AGN-980235062-.+-[0-9]{3,3}</searchPattern>
						</sourceResource>
						<targetResource>
							<uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
							<matchedUriOutputProperty>CTR-AGN-980-FILE</matchedUriOutputProperty>
						</targetResource>
					</transfer>
					<transferCountProperty>matchedCountTransfer</transferCountProperty>
				</fileTransfer>
			</execDefinition>
		</stage>
		<parallel id="CHECKSUM" name="CHECKSUM">
			<stage name="CHECKSUM-FUNDTRACKER-IG-CODES" id="CHECKSUM-FUNDTRACKER-IG-CODES">
				<description>Validate checksum for file fundtracker_ig_codes</description>
				<execDefinition>
					<checksumValidation>
						<sourceResource>
							<uri>${ALDOP-FILEWATCH-WF.FUNDTRACKER-FILE}</uri>
						</sourceResource>
						<markerResource>
							<uri>${ALDOP-FILEWATCH-WF.FUNDTRACKER-FILE-MRK}</uri>
						</markerResource>
						<checksumAlgorithm>SHA256</checksumAlgorithm>
					</checksumValidation>
				</execDefinition>
			</stage>
		</parallel>

		<!-- If multiple ALDOP files in source data directory, move the files with older version to infile/notload directory -->
		<stage enabled="true" id="ALDOP-CLEAN-OLD-VERSION" name="ALDOP-CLEAN-OLD-VERSION">
            <execDefinition>
                <callExternalProcess>
                    <commandLine>${CTR_ROOT_PATH}/ctrapp/script/aldop-clean.sh ${DATA-NOTLOAD-DIR} AGD-134941099 AGD-135239583 AGD-980235062 AGN-134941099 AGN-135239583 AGN-980235062</commandLine>
                    <workingDirectory>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</workingDirectory>
                    <exitCodeProperty>ALDOP-VERSION</exitCodeProperty>
                </callExternalProcess>
            </execDefinition>
        </stage>
        
		<stage id="FORMAT-FILENAME-GET-VERSION" name="FORMAT-FILENAME-GET-VERSION">
			<execDefinition>
				<javaExtension>
					<javaExtensionExecutorClassName>com.bns.ctr.maestro.javaexec.FileNameRetriever</javaExtensionExecutorClassName>
					<simpleProperties>
						<properties>
							<simpleProperty name="method">appendDateToFileNames</simpleProperty>
							<simpleProperty name="wfInputParam">filePath=${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}/;bDate=${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED};version=${ALDOP-CLEAN-OLD-VERSION.ALDOP-VERSION}</simpleProperty>
						</properties>
					</simpleProperties>
					<javaExtensionOutputPropertyNames>
						<propertyName>RenameAllFiles</propertyName>
						<propertyName>version</propertyName>
						<propertyName>AGN_135_FILE</propertyName>
						<propertyName>AGD_135_FILE</propertyName>
						<propertyName>AGN_134_FILE</propertyName>
						<propertyName>AGD_134_FILE</propertyName>
						<propertyName>AGN_980_FILE</propertyName>
						<propertyName>AGD_980_FILE</propertyName>
					</javaExtensionOutputPropertyNames>
				</javaExtension>
			</execDefinition>
		</stage>

		<!-- Generate marker files  -->
		<parallel id="GENERATE-CHECKSUM-LOANET-SOURCE-FILE" name="GENERATE-CHECKSUM-LOANET-SOURCE-FILE">
			<stage name="GENERATE-CHECKSUM-AGD-134-FILE" id="GENERATE-CHECKSUM-AGD-134-FILE">
				<description>Validate checksum for file fundtracker_ig_codes</description>
				<execDefinition>
					<checksumGeneration>
						<sourceResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGN_134_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</uri>
						</sourceResource>
						<markerResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGN_134_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</uri>
						</markerResource>
						<checksumAlgorithm>SHA256</checksumAlgorithm>
					</checksumGeneration>
				</execDefinition>
			</stage>
			<stage name="GENERATE-CHECKSUM-AGD-135-FILE" id="GENERATE-CHECKSUM-AGD-135-FILE">
				<description>Validate checksum for file fundtracker_ig_codes</description>
				<execDefinition>
					<checksumGeneration>
						<sourceResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGN_135_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</uri>
						</sourceResource>
						<markerResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGN_135_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</uri>
						</markerResource>
						<checksumAlgorithm>SHA256</checksumAlgorithm>
					</checksumGeneration>
				</execDefinition>
			</stage>
			<stage name="GENERATE-CHECKSUM-AGD-980-FILE" id="GENERATE-CHECKSUM-AGD-980-FILE">
				<description>Validate checksum for file fundtracker_ig_codes</description>
				<execDefinition>
					<checksumGeneration>
						<sourceResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGN_980_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</uri>
						</sourceResource>
						<markerResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGN_980_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</uri>
						</markerResource>
						<checksumAlgorithm>SHA256</checksumAlgorithm>
					</checksumGeneration>
				</execDefinition>
			</stage>
			<stage name="GENERATE-CHECKSUM-AGN-134-FILE" id="GENERATE-CHECKSUM-AGN-134-FILE">
				<description>Validate checksum for file fundtracker_ig_codes</description>
				<execDefinition>
					<checksumGeneration>
						<sourceResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGD_134_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</uri>
						</sourceResource>
						<markerResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGD_134_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</uri>
						</markerResource>
						<checksumAlgorithm>SHA256</checksumAlgorithm>
					</checksumGeneration>
				</execDefinition>
			</stage>
			<stage name="GENERATE-CHECKSUM-AGN-135-FILE" id="GENERATE-CHECKSUM-AGN-135-FILE">
				<description>Validate checksum for file fundtracker_ig_codes</description>
				<execDefinition>
					<checksumGeneration>
						<sourceResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGD_135_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</uri>
						</sourceResource>
						<markerResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGD_135_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</uri>
						</markerResource>
						<checksumAlgorithm>SHA256</checksumAlgorithm>
					</checksumGeneration>
				</execDefinition>
			</stage>
			<stage name="GENERATE-CHECKSUM-AGN-134-FILE" id="GENERATE-CHECKSUM-AGN-980-FILE">
				<description>Validate checksum for file fundtracker_ig_codes</description>
				<execDefinition>
					<checksumGeneration>
						<sourceResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGD_980_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</uri>
						</sourceResource>
						<markerResource>
							<uri>${FORMAT-FILENAME-GET-VERSION.AGD_980_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</uri>
						</markerResource>
						<checksumAlgorithm>SHA256</checksumAlgorithm>
					</checksumGeneration>
				</execDefinition>
			</stage>
		</parallel>
       
        <stage enabled="true" id="ALDOP-CONVERT-TO-CTR-FORMAT" name="ALDOP-CONVERT-TO-CTR-FORMAT">
            <execDefinition>
                <callExternalProcess>
                    <commandLine>${CTR_ROOT_PATH}/ctrapp/script/aldop-convert.sh LOANET ${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED} ${ALDOP-CLEAN-OLD-VERSION.ALDOP-VERSION} ${FORMAT-FILENAME-GET-VERSION.AGD_135_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED} ${FORMAT-FILENAME-GET-VERSION.AGN_135_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED} ${FORMAT-FILENAME-GET-VERSION.AGD_134_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED} ${FORMAT-FILENAME-GET-VERSION.AGN_134_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED} ${FORMAT-FILENAME-GET-VERSION.AGD_980_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED} ${FORMAT-FILENAME-GET-VERSION.AGN_980_FILE}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED} ${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR}/ </commandLine>
                    <workingDirectory>${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR}</workingDirectory>
                    <exitCodeProperty>exitCode</exitCodeProperty>
                </callExternalProcess>
            </execDefinition>
        </stage>
		<stage enabled="true" id="FUNDTRACKER-CONVERT-TO-CTR-FORMAT" name="FUNDTRACKER-CONVERT-TO-CTR-FORMAT">
            <execDefinition>
                <callExternalProcess>
					<commandLine>${CTR_ROOT_PATH}/ctrapp/script/prep-fundtracker-file.sh LOANET ${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED} ${ALDOP-CLEAN-OLD-VERSION.ALDOP-VERSION} ${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR} ${ALDOP-FILEWATCH-WF.FUNDTRACKER-FILE} </commandLine>
                    <workingDirectory>${CTR_FTP_ROOT_PATH}/${FUNDTRACKER-FTP-SRC-DIR}</workingDirectory>
                    <exitCodeProperty>exitCode</exitCodeProperty>
                </callExternalProcess>
            </execDefinition>
        </stage>
        <stage id="INIT-COMPLETE-CHECK" name="INIT-COMPLETE-CHECK">
            <description>Verify if the common workflow steps completed</description>
            <stageFailure>
                <failureCondition>${INITIALIZE-RUN.P_RUN_ID_O} &lt;= 0 || "${CTR_APP_ROOT_PATH}" == '' || "${CTR_ROOT_PATH}" == ''|| "${CTR_FTP_ROOT_PATH}" == ''|| "${CTR_DATA_ROOT_PATH}" == ''|| "${CTR_CONFIG_ROOT_PATH}" == ''</failureCondition>
                <failureMessage>Common workflow initialization failed</failureMessage>
            </stageFailure>
            <execDefinition>
                <noOpExecDefinition>
                    <input>CHECK-IF-INIT-COMPLETE</input>
                    <numberOfTasks>1</numberOfTasks>
                    <numberOfInterimStatusResponses>1</numberOfInterimStatusResponses>
                    <durationBetweenEventsInMs>250</durationBetweenEventsInMs>
                    <outputPropertyName>output</outputPropertyName>
                </noOpExecDefinition>
            </execDefinition>
        </stage>
        <stage id="GET-FILE-NAME" name="GET-FILE-NAME">
			<execDefinition>
				<javaExtension>
					<javaExtensionExecutorClassName>com.bns.ctr.maestro.javaexec.FileNameRetriever</javaExtensionExecutorClassName>
					<simpleProperties>
						<properties>
							<simpleProperty name="method">getFileName</simpleProperty>
							<simpleProperty name="wfInputParam">filePath=${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR}/;regEx=LOANET_${SRC-FILE-SUFFIX-PATTERN-2}${FORMAT-FILENAME-GET-VERSION.version}.csv$</simpleProperty>
							<!-- <simpleProperty name="filePath">${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR}/</simpleProperty>
							<simpleProperty name="regEx">LOANET_${SRC-FILE-SUFFIX-PATTERN-1}.csv</simpleProperty> -->
						</properties>
					</simpleProperties>
					<javaExtensionOutputPropertyNames>
						<propertyName>fileName</propertyName>
					</javaExtensionOutputPropertyNames>
				</javaExtension>
			</execDefinition>
		</stage>
        <externalWorkflowReference enabled="true"
            id="PREPARE-LOAD-WF" name="PREPARE-LOAD-WF">
            <skipCondition>${ALDOP-FILEWATCH-WF.matchedCount} == 0</skipCondition>
            <externalWorkflowCode>PREPARE-CM-LOAD-WF</externalWorkflowCode>
            <inputProperties>
                <property name="IS-MONTH-END">${INITIALIZE-RUN.IS-MONTH-END}</property>
                <property name="SOURCE-SYSTEM-LC">loanet</property>
                <property name="CTR-SOURCE-SYSTEM-CODE">LOANET</property>
                <property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
                <property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
                <property name="FTP-SOURCE-DIR">${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</property>
                <property name="PROCESSING-DIR">${CTR_DATA_INBOUND_PATH}</property>
                <property name="HOLDING-SOURCE-DIR">${HOLDING-DIR}</property>
                <property name="REPLICATE-IF-MONTH-END">${REPLICATE-SRC-IF-MONTH-END}</property>
                <property name="EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
                <property name="SOURCE-SYSTEM">LOANET</property>
            </inputProperties>
        </externalWorkflowReference>

		<parallel id="LOAD-SOURCE-FILES" name="LOAD-SOURCE-FILES">
			<externalWorkflowReference enabled="true"
				id="LOAD-ALDOP-PRE-LANDING" name="LOAD-ALDOP-PRE-LANDING">
				<externalWorkflowCode>LOAD-FILE-WF</externalWorkflowCode>
				<inputProperties>
					<property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
					<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
					<property name="CONTROL-PATH">${CTR_CONFIG_ROOT_PATH}/${SQLLDR-CONTROL-DIRECTORY}</property>
					<property name="DATA-CATEGORY">${DATA-CATEGORY-TYPE}</property>
					<property name="DELIMITER">,</property>
					<property name="DISCARD-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-DISCARD-DIR}</property>
					<property name="SOURCE-FILE">${GET-FILE-NAME.fileName}</property>
					<property name="LOG-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-LOG-DIRECTORY}</property>
					<property name="PROCESSING-SOURCE-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR}</property>
					<property name="REJECT-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-REJECT-DIRECTORY}</property>
				</inputProperties>
			</externalWorkflowReference>
		</parallel>

		 <!-- Request CSM for the price of loanet instrument -->
		<externalWorkflowReference name="CM-CSM-WF" id="CM-CSM-WF">
			<externalWorkflowCode>CM-CSM-WF</externalWorkflowCode>
				<inputProperties>
					<property name="WF-EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
					<property name="SOURCE-SYSTEM">LOANET</property>
					<!-- TBD conflict with CSM enrichment in later stage -->
					<property name="RUN-ID" >${INITIALIZE-RUN.P_RUN_ID_O}</property>
					<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
					<property name="BUSINESS-DATE-FORMATTED">${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</property>
					<property name="IS-MONTH-END">${INITIALIZE-RUN.IS-MONTH-END}</property>
				</inputProperties>
		</externalWorkflowReference>

		<stage enabled="true" id="PRELAND-TO-LAND-ALDOP-EXPOSURE" name="PRELAND-TO-LAND-ALDOP-EXPOSURE">
			<description>Loads loanet data to sbl exposure landing</description>
			<execDefinition>
				<dbProcedure name="CTRMSO.ETL_INVOKER_SP">
					<in>
						<param name="P_TYPE_NAME_I" type="STRING">aldop_exposure_tp</param>
						<param name="P_METHOD_NAME_I" type="STRING">pub_move_pre_landing</param>
						<param name="P_RUN_ID_I" type="NUMBER">${INITIALIZE-RUN.P_RUN_ID_O}</param>
						<param name="P_STAGE_ID_I" type="STRING">STAGING</param>
						<param name="P_TASK_ID_I" type="STRING">PA-LOANET-B4L-EXPSOURE</param>
						<param name="P_LOG_ID_I" type="STRING">1</param>
						<param name="P_BUSINESS_DATE_I" type="STRING">${INITIALIZE-RUN.BUSINESS-DATE}</param>
						<param name="P_SOURCE_SYSTEM_CD_I" type="STRING">LOANET</param>
					</in>
					<out>
						<param name="P_RET_VALUE_O" type="NUMBER" />
						<param name="P_RET_MESSAGE_O" type="STRING" />
					</out>
					<outputPropertyMapping>
						<mapping source="P_RET_VALUE_O" target="P_RET_VALUE_O" />
						<mapping source="P_RET_MESSAGE_O" target="P_RET_MESSAGE_O" />
					</outputPropertyMapping>
				</dbProcedure>
			</execDefinition>
		</stage>
		 <stage enabled="true"
			 id="PRELAND-TO-LAND-ALDOP-SBLCOLLATERAL" name="PRELAND-TO-LAND-ALDOP-SBLCOLLATERAL">
			 <description>Loads loanet data to sbl collateral, basket landing</description>
			 <execDefinition>
				 <dbProcedure name="CTRMSO.ETL_INVOKER_SP">
					 <in>
						 <param name="P_TYPE_NAME_I" type="STRING">aldop_sblcollateral_tp</param>
						 <param name="P_METHOD_NAME_I" type="STRING">pub_move_pre_landing</param>
						 <param name="P_RUN_ID_I" type="NUMBER">${INITIALIZE-RUN.P_RUN_ID_O}</param>
						 <param name="P_STAGE_ID_I" type="STRING">STAGING</param>
						 <param name="P_TASK_ID_I" type="STRING">PA-LOANET-B4L-SBLCOLLATERAL</param>
						 <param name="P_LOG_ID_I" type="STRING">1</param>
						 <param name="P_BUSINESS_DATE_I" type="STRING">${INITIALIZE-RUN.BUSINESS-DATE}</param>
						 <param name="P_SOURCE_SYSTEM_CD_I" type="STRING">LOANET</param>
					 </in>
					 <out>
						 <param name="P_RET_VALUE_O" type="NUMBER"/>
						 <param name="P_RET_MESSAGE_O" type="STRING"/>
					 </out>
					 <outputPropertyMapping>
						 <mapping source="P_RET_VALUE_O" target="P_RET_VALUE_O"/>
						 <mapping source="P_RET_MESSAGE_O" target="P_RET_MESSAGE_O"/>
					 </outputPropertyMapping>
				 </dbProcedure>
			 </execDefinition>
		 </stage>
		<stage enabled="true" id="PRELAND-TO-LAND-ALDOP-FUNDTRACKER" name="PRELAND-TO-LAND-ALDOP-FUNDTRACKER">
             <description>Loads fundtracker data to legal entity landing</description>
             <execDefinition>
                 <dbProcedure name="CTRMSO.ETL_INVOKER_SP">
                     <in>
                         <param name="P_TYPE_NAME_I" type="STRING">aldop_legalentity_tp</param>
                         <param name="P_METHOD_NAME_I" type="STRING">pub_move_pre_landing</param>
                         <param name="P_RUN_ID_I" type="NUMBER">${INITIALIZE-RUN.P_RUN_ID_O}</param>
                         <param name="P_STAGE_ID_I" type="STRING">STAGING</param>
                         <param name="P_TASK_ID_I" type="STRING">PA-LOANET-B4L-FUNDTRACKER</param>
                         <param name="P_LOG_ID_I" type="STRING">1</param>
                         <param name="P_BUSINESS_DATE_I" type="STRING">${INITIALIZE-RUN.BUSINESS-DATE}</param>
                         <param name="P_SOURCE_SYSTEM_CD_I" type="STRING">LOANET</param>
                     </in>
                     <out>
                         <param name="P_RET_VALUE_O" type="NUMBER"/>
                         <param name="P_RET_MESSAGE_O" type="STRING"/>
                     </out>
                     <outputPropertyMapping>
                         <mapping source="P_RET_VALUE_O" target="P_RET_VALUE_O"/>
                         <mapping source="P_RET_MESSAGE_O" target="P_RET_MESSAGE_O"/>
                     </outputPropertyMapping>
                 </dbProcedure>
             </execDefinition>
         </stage>
         <externalWorkflowReference enabled="true"
             id="CM-ETL-WF" name="CM-ETL-WF">
             <skipCondition>${ALDOP-FILEWATCH-WF.matchedCount} == 0</skipCondition>
             <externalWorkflowCode>CM-ETL-WF</externalWorkflowCode>
             <inputProperties>
                 <property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
                 <property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
                 <property name="EOD-EOM-IND">${WF-EOD-EOM-INDICATOR}</property>
                 <property name="SOURCE-SYSTEM">LOANET</property>
                 <property name="SOURCE-SYSTEM-LC">loanet</property>
             </inputProperties>
         </externalWorkflowReference>

		<!-- Enrichment part 2 -->
		<externalWorkflowReference name="CM-EXPORT-LINK-INSTRUMENT-WF" id="CM-EXPORT-CSM-PRE-LINK-WF">
			<externalWorkflowCode>CM-EXPORT-LINK-INSTRUMENT-WF</externalWorkflowCode>
			<inputProperties>
				<property name="WF-EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
					<property name="SOURCE-SYSTEM">LOANET</property>
					<property name="RUN-ID" >${INITIALIZE-RUN.P_RUN_ID_O}</property>
					<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
					<property name="BUSINESS-DATE-FORMATTED">${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</property>
					<property name="IS-MONTH-END">${INITIALIZE-RUN.IS-MONTH-END}</property>
			</inputProperties>
		</externalWorkflowReference>

		<externalWorkflowReference name="CM-EXPORT-CSM-CUT-OFF-WF" id="CM-EXPORT-CSM-CUT-OFF-WF">
			<externalWorkflowCode>CM-EXPORT-CSM-CUT-OFF-WF</externalWorkflowCode>
			<inputProperties>
				<property name="WF-EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
					<property name="SOURCE-SYSTEM">LOANET</property>
					<property name="RUN-ID" >${INITIALIZE-RUN.P_RUN_ID_O}</property>
					<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
					<property name="BUSINESS-DATE-FORMATTED">${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</property>
					<property name="IS-MONTH-END">${INITIALIZE-RUN.IS-MONTH-END}</property>
			</inputProperties>
		</externalWorkflowReference>
		<!-- Move the Aldop (Loanet) source files to ctrdata/data_in/infiles directory -->
        <stage enabled="true" id="ALDOP-MOVE-FILES" name="ALDOP-MOVE-FILES">
            <execDefinition>
                <callExternalProcess>
					<commandLine>${CTR_ROOT_PATH}/ctrapp/script/aldop-move-files.sh ${CTR_DATA_INBOUND_PATH} ${ALDOP-FILEWATCH-WF.FUNDTRACKER-FILE} ${ALDOP-FILEWATCH-WF.FUNDTRACKER-FILE-MRK} </commandLine>
                    <workingDirectory>${CTR_FTP_ROOT_PATH}/${FUNDTRACKER-FTP-SRC-DIR}</workingDirectory>
                    <exitCodeProperty>exitCode</exitCodeProperty>
                </callExternalProcess>
            </execDefinition>
        </stage>
        
        <stage name="CLEAN-UP-FTP-DIR" id="CLEAN-UP-FTP-DIR">
			<description>Clean up files in FTP directory</description>
			<skipCondition>'${ALDOP-FILEWATCH-WF.matchedCount}' == '0' </skipCondition>
			<execDefinition>
				<deleteResource failOnError="false">
					<resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGD-134941099-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGD-135239583-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGD-980235062-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGN-134941099-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGN-135239583-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGN-980235062-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGD-134941099-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGD-135239583-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGD-980235062-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGN-134941099-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGN-135239583-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                            <searchPattern>AGN-980235062-.+-[0-9]{3,3}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FUNDTRACKER-FTP-SRC-DIR}</uri>
                            <searchPattern>fundtracker_ig_codes_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.csv</searchPattern>
                        </resource>
                        <resource>
                            <uri>${CTR_FTP_ROOT_PATH}/${FUNDTRACKER-FTP-SRC-DIR}</uri>
                            <searchPattern>fundtracker_ig_codes_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}.mrk</searchPattern>
                        </resource>
					<deleteCountProperty>matchedDelRemCount</deleteCountProperty>
				</deleteResource>
			</execDefinition>
		</stage>
		
        <externalWorkflowReference id="COMPLETE-RUN" name="FINALIZE-RUN">
            <description>Finalize the run and mark complete</description>
            <externalWorkflowCode>FINALIZE-RUN</externalWorkflowCode>
            <inputProperties>
                <property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
                <property name="SRC-FILE-SUFFIX-PATTERN">${SRC-FILE-SUFFIX-PATTERN-1}</property>
                <property name="FTP-SOURCE-DIR">${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</property>
                <property name="SOURCE-SYSTEM">LOANET</property>
                <property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
            </inputProperties>
        </externalWorkflowReference>
    </sequential>
</workflow>
