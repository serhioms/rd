<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- $Id: ctr-cm-eod-refdata-ecards-wf.xml 4168 2016-06-23 19:16:47Z gmusial $
	 Maestro version: 1.16.0 -->
	 
<!-- NOTE: The workflow should be started at 5AM, in case the file is not there the workflow will skip.
This is to avoid running this workflow along with the lancelot extract after lancelot cutoff. See Jira GGNCRPLT-619 -->
	
<workflow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="workflowDefinition.xsd">
	<name>ctr-cm-eod-refdata-ecards-wf</name> 
  	<externalWorkflowCode>ctr-cm-eod-refdata-ecards-wf</externalWorkflowCode> 
  	<finishOrchestrationASAPOnError>false</finishOrchestrationASAPOnError> 
	<description>ctr-cm-eod-refdata-ecards-wf ($LastChangedRevision: 4168 $)</description>
	
	<properties>
		<inputProperties>
			<property name="WF-EOD-EOM-INDICATOR">D</property>
			<property name="RUN-INSTANCE">1</property>
		</inputProperties>
		<generalProperties>
			<property name="ROOT-WF-ID">ctr-cm-eod-refdata-ecards-wf</property>
			<property name="WORKFLOW_RUN_ID">0</property>
			<!-- Source Directories -->
			<property name="FTP-SOURCE-DIR">ecards/inbox</property>
			<property name="HOLDING-DIR">${CTR_DATA_ROOT_PATH}/manual/ecards</property>
			<property name="HOLDING-MATCH-PATTERN">.+_${WF-EOD-EOM-INDICATOR}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}_.+</property>
			<property name="SQLLDR-PROCESSING-SOURCE-DIR">data_in/infiles</property>
			<property name="SQLLDR-CONTROL-DIRECTORY">sqlldr</property>
			<property name="SQLLDR-DISCARD-DIR">data_in/discard</property>
			<property name="SQLLDR-REJECT-DIRECTORY">data_in/reject</property>
			<property name="SQLLDR-LOG-DIRECTORY">data_in/ldrlog</property>
			
			<property name="REPLICATE-SRC-IF-MONTH-END">F</property>
			<property name="DATA-CATEGORY-TYPE">CM</property>
			
			<!-- Source file naming pattern -->
			<property name="SRC-FILE-SUFFIX-PATTERN-1">${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</property>
		</generalProperties>
	</properties>	

	<sequential name="CTR-CAPITAL-MARKETS" id="CTR-CAPITAL-MARKETS">
	
		<externalWorkflowReference name="INITIALIZE-RUN" id="INITIALIZE-RUN">
			<externalWorkflowCode>INITIALIZE-RUN</externalWorkflowCode>
			<inputProperties>
				<property name="EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
				<property name="SOURCE-SYSTEM">CTR</property>
				<property name="ROOT-WF-ID">${ROOT-WF-ID}</property>
				<property name="TARGET-SYSTEM"></property>
				<property name="RUN-TYPE" />
				<property name="RUN-INSTANCE">${RUN-INSTANCE}</property>
				<property name="WORKFLOW-RUN-ID">${WORKFLOW_RUN_ID}</property>
			</inputProperties>
			<outputPropertyMapping>
				<mapping source="BUSINESS-DATE" target="BUSINESS-DATE"/>
				<mapping source="BUSINESS-DATE-FORMATTED" target="BUSINESS-DATE-FORMATTED"/>
				<mapping source="RUN-ID" target="P_RUN_ID_O"/>
				<mapping source="IS-MONTH-END" target="IS-MONTH-END"/>
			</outputPropertyMapping>
		</externalWorkflowReference>
		
		<externalWorkflowReference name="PREPARE-SOURCE-FILES" id="PREPARE-SOURCE-FILES">
			<externalWorkflowCode>PREPARE-SOURCE-FILES</externalWorkflowCode>
			<inputProperties>
				<property name="FTP-SOURCE-DIR">${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</property>
				<property name="HOLDING-SOURCE-DIR">${HOLDING-DIR}</property>
				<property name="HOLDING-MATCH-PATTERN">${HOLDING-MATCH-PATTERN}</property>
				<property name="IS-MONTH-END">${INITIALIZE-RUN.IS-MONTH-END}</property>
				<property name="EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
			</inputProperties>
		</externalWorkflowReference>
		
		<stage name="INIT-COMPLETE-CHECK" id="INIT-COMPLETE-CHECK">
			<description>Verify if the common workflow steps completed</description>
			<stageFailure>
				<failureCondition><![CDATA[${INITIALIZE-RUN.P_RUN_ID_O} <= 0 || "${CTR_APP_ROOT_PATH}" == '' || "${CTR_ROOT_PATH}" == ''|| "${CTR_FTP_ROOT_PATH}" == ''|| "${CTR_DATA_ROOT_PATH}" == ''|| "${CTR_CONFIG_ROOT_PATH}" == '']]></failureCondition>
				<failureMessage>Common workflow initialization failed</failureMessage>
			</stageFailure>
			<execDefinition>
				<noOpExecDefinition>
					<input>CHECK-IF-INIT-COMPLETE</input>
					<numberOfTasks>1</numberOfTasks>
					<numberOfInterimStatusResponses>1</numberOfInterimStatusResponses>
				</noOpExecDefinition>
			</execDefinition>
		</stage>
		
		<!-- CTR-WORKFLOWS -->
		
		<parallel id="CTR-WORKFLOWS" name="CTR-WORKFLOWS">
			<sequential id="CTR" name="CTR">	
      
				<stage name="FILEWATCH-WF" id="FILEWATCH-WF">
					<autoRetryConfiguration>
						<delayBetweenAttemptsInMs>60000</delayBetweenAttemptsInMs>
                        <maximumNumberOfRetryAttempts>720</maximumNumberOfRetryAttempts>
                        <maximumRetryDurationInMs>43200000</maximumRetryDurationInMs>
					</autoRetryConfiguration>
					<execDefinition>
						<pollingFileWatcher>
							<watchedFiles>
								<resource>
									<uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
									<searchPattern>ecards_extract_${SRC-FILE-SUFFIX-PATTERN-1}.txt</searchPattern>
									<matchedUriOutputProperty>CM-CARDSExtract-FILE</matchedUriOutputProperty>
								</resource>
								<resource>
									<uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
									<searchPattern>ecards_extract_${SRC-FILE-SUFFIX-PATTERN-1}.mrk</searchPattern>
									<matchedUriOutputProperty>CM-CARDSExtract-MRK</matchedUriOutputProperty>
								</resource>
							</watchedFiles>
							<matchedCountProperty>matchedCount</matchedCountProperty>
							<allowFileNotFound>true</allowFileNotFound>
						</pollingFileWatcher>
					</execDefinition>
				</stage>
				<parallel id="CHECKSUM" name="CHECKSUM">
					<skipCondition>${FILEWATCH-WF.matchedCount} == 0</skipCondition>
					<stage name="CHECKSUM-SAG-ECARDS" id="CHECKSUM-SAG-ECARDS">
						<description>Validate checksum for file CARDS extract</description>
						<execDefinition>
							<checksumValidation>
								<sourceResource>
									<uri>${FILEWATCH-WF.CM-CARDSExtract-FILE}</uri>
								</sourceResource>
								<markerResource>
									<uri>${FILEWATCH-WF.CM-CARDSExtract-MRK}</uri>
								</markerResource>
								<checksumAlgorithm>SHA1</checksumAlgorithm>
							</checksumValidation>
						</execDefinition>
					</stage>
				</parallel>
        
        <stage name="FILEWATCH-WF" id="FILEWATCH-WF-2">
					<autoRetryConfiguration>
						<delayBetweenAttemptsInMs>60000</delayBetweenAttemptsInMs>
                        <maximumNumberOfRetryAttempts>720</maximumNumberOfRetryAttempts>
                        <maximumRetryDurationInMs>43200000</maximumRetryDurationInMs>
					</autoRetryConfiguration>
					<execDefinition>
						<pollingFileWatcher>
							<watchedFiles>
								<resource>
									<uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
									<searchPattern>ecards_facility_extract_${SRC-FILE-SUFFIX-PATTERN-1}.txt</searchPattern>
									<matchedUriOutputProperty>CM-CARDSFacilityExtract-FILE</matchedUriOutputProperty>
								</resource>
								<resource>
									<uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
									<searchPattern>ecards_facility_extract_${SRC-FILE-SUFFIX-PATTERN-1}.mrk</searchPattern>
									<matchedUriOutputProperty>CM-CARDSFacilityExtract-MRK</matchedUriOutputProperty>
								</resource>
							</watchedFiles>
							<matchedCountProperty>matchedCount</matchedCountProperty>
							<allowFileNotFound>true</allowFileNotFound>
						</pollingFileWatcher>
					</execDefinition>
				</stage>
				<parallel id="CHECKSUM-2" name="CHECKSUM">
					<skipCondition>${FILEWATCH-WF-2.matchedCount} == 0</skipCondition>
					<stage name="CHECKSUM-SAG-ECARDS-FACIL" id="CHECKSUM-SAG-ECARDS-FACIL">
						<description>Validate checksum for file CARDS facility extract</description>
						<execDefinition>
							<checksumValidation>
								<sourceResource>
									<uri>${FILEWATCH-WF-2.CM-CARDSFacilityExtract-FILE}</uri>
								</sourceResource>
								<markerResource>
									<uri>${FILEWATCH-WF-2.CM-CARDSFacilityExtract-MRK}</uri>
								</markerResource>
								<checksumAlgorithm>SHA1</checksumAlgorithm>
							</checksumValidation>
						</execDefinition>
					</stage>
				</parallel>
      
				<externalWorkflowReference name="PREPARE-LOAD-WF" id="PREPARE-LOAD-WF">
					<skipCondition>${FILEWATCH-WF.matchedCount} == 0 and ${FILEWATCH-WF-2.matchedCount} == 0</skipCondition>
					<externalWorkflowCode>PREPARE-CM-LOAD-WF</externalWorkflowCode>
					<inputProperties>
						<property name="SOURCE-SYSTEM">ECARDS</property>
						<property name="SOURCE-SYSTEM-LC">ecards</property>
						<property name="CTR-SOURCE-SYSTEM-CODE">CTR</property>
						<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
						<property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
						<property name="FTP-SOURCE-DIR">${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</property>
						<property name="PROCESSING-DIR">${CTR_DATA_INBOUND_PATH}</property>
						<property name="HOLDING-SOURCE-DIR">${HOLDING-DIR}</property>
						<property name="REPLICATE-IF-MONTH-END">${REPLICATE-SRC-IF-MONTH-END}</property>
						<property name="IS-MONTH-END">${INITIALIZE-RUN.IS-MONTH-END}</property>
						<property name="EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
					</inputProperties>
				</externalWorkflowReference>
        
				<parallel id="LOAD" name="LOAD-SOURCE-FILES">
				 	<skipCondition>${FILEWATCH-WF.matchedCount} == 0</skipCondition>
					<externalWorkflowReference name="LOAD-SAG-ECARDS" id="LOAD-SAG-ECARDS">
						<externalWorkflowCode>LOAD-FILE-WF</externalWorkflowCode>
						<inputProperties>
							<property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
							<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
							<property name="SOURCE-FILE">${FILEWATCH-WF.CM-CARDSExtract-FILE}</property>
							<property name="PROCESSING-SOURCE-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR}</property>
							<property name="CONTROL-PATH">${CTR_CONFIG_ROOT_PATH}/${SQLLDR-CONTROL-DIRECTORY}</property>
							<property name="DISCARD-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-DISCARD-DIR}</property>
							<property name="REJECT-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-REJECT-DIRECTORY}</property>
							<property name="LOG-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-LOG-DIRECTORY}</property>
							<property name="DATA-CATEGORY">${DATA-CATEGORY-TYPE}</property>
      				<property name="DELIMITER">\t</property>
						</inputProperties>
					</externalWorkflowReference>
				</parallel>
        
				<parallel id="LOAD-2" name="LOAD-SOURCE-FILES">
				 	<skipCondition>${FILEWATCH-WF-2.matchedCount} == 0</skipCondition>
					<externalWorkflowReference name="LOAD-SAG-ECARDS-FACIL" id="LOAD-SAG-ECARDS-FACIL">
						<externalWorkflowCode>LOAD-FILE-WF</externalWorkflowCode>
						<inputProperties>
							<property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
							<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
							<property name="SOURCE-FILE">${FILEWATCH-WF-2.CM-CARDSFacilityExtract-FILE}</property>
							<property name="PROCESSING-SOURCE-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR}</property>
							<property name="CONTROL-PATH">${CTR_CONFIG_ROOT_PATH}/${SQLLDR-CONTROL-DIRECTORY}</property>
							<property name="DISCARD-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-DISCARD-DIR}</property>
							<property name="REJECT-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-REJECT-DIRECTORY}</property>
							<property name="LOG-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-LOG-DIRECTORY}</property>
							<property name="DATA-CATEGORY">${DATA-CATEGORY-TYPE}</property>
      				<property name="DELIMITER">\t</property>
						</inputProperties>
					</externalWorkflowReference>
				</parallel>
        
				<externalWorkflowReference name="CM-ETL-REFDATA-WF" id="CM-ETL-REFDATA-WF-2">
					<skipCondition>${FILEWATCH-WF.matchedCount} == 0 and ${FILEWATCH-WF-2.matchedCount} == 0</skipCondition>
					<externalWorkflowCode>CM-ETL-REFDATA-WF</externalWorkflowCode>
					<inputProperties>
						<property name="SOURCE-SYSTEM">CTR</property>
						<property name="SOURCE-SYSTEM-LC">ctr</property>
						<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
						<property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
						<property name="EOD-EOM-IND">${WF-EOD-EOM-INDICATOR}</property>
					</inputProperties>
				</externalWorkflowReference>
        
			</sequential>
		</parallel>
		
		<!-- FINALIZE PHASE -->
		<stage name="CLEAN-UP-FTP-DIR" id="CLEAN-UP-FTP-DIR">
			<description>Clean up files in FTP directory</description>
			<skipCondition>${FILEWATCH-WF.matchedCount} == 0</skipCondition>
			<execDefinition>
				<deleteResource failOnError="false">
				<resource>
					<uri>${FILEWATCH-WF.CM-CARDSExtract-FILE}</uri>
				</resource>
				<resource>
					<uri>${FILEWATCH-WF.CM-CARDSExtract-MRK}</uri>
				</resource>
				<deleteCountProperty>matchedCount</deleteCountProperty>
				</deleteResource>
			</execDefinition>
		</stage>

		<stage name="CLEAN-UP-FTP-DIR" id="CLEAN-UP-FTP-DIR-2">
			<description>Clean up files in FTP directory</description>
			<skipCondition>${FILEWATCH-WF-2.matchedCount} == 0</skipCondition>
			<execDefinition>
				<deleteResource failOnError="false">
				<resource>
					<uri>${FILEWATCH-WF-2.CM-CARDSFacilityExtract-FILE}</uri>
				</resource>
				<resource>
					<uri>${FILEWATCH-WF-2.CM-CARDSFacilityExtract-MRK}</uri>
				</resource>
				<deleteCountProperty>matchedCount</deleteCountProperty>
				</deleteResource>
			</execDefinition>
		</stage>
    
		<externalWorkflowReference name="FINALIZE-RUN" id="COMPLETE-RUN">
			<description>Finalize the run and mark complete</description>
			<externalWorkflowCode>FINALIZE-RUN</externalWorkflowCode>
			<inputProperties>
				<property name="SOURCE-SYSTEM">NONE</property>
				<property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
				<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
				<property name="SRC-FILE-SUFFIX-PATTERN">${SRC-FILE-SUFFIX-PATTERN-1}</property>
				<property name="FTP-SOURCE-DIR">${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</property>
			</inputProperties>
		</externalWorkflowReference>
	</sequential>
</workflow>