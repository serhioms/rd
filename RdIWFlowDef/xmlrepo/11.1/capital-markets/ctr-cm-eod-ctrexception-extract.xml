<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- $Id: ctr-cm-eod-ctrexception-extract.xml 9339 2015-12-23 22:26:42Z hho1 
	$ Maestro version: 1.16.0 -->

<workflow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="workflowDefinition.xsd">
	<name>ctr-cm-eod-ctrexception-extract</name>
	<externalWorkflowCode>ctr-cm-eod-ctrexception-extract</externalWorkflowCode>
	<finishOrchestrationASAPOnError>false</finishOrchestrationASAPOnError>
	<description>ctr-cm-eod-ctrexception-extract ($LastChangedRevision: 4168 $)</description>

	<!-- TODO: make these into input properties and pass from tidal -->
	<properties>
		<inputProperties>
			<property name="WF-EOD-EOM-INDICATOR">D</property>
			<property name="RUN-INSTANCE">1</property>
			<property name="IN-SOURCE-SYSTEM" />
		</inputProperties>
		<generalProperties>
			<property name="ROOT-WF-ID">ctr-cm-eod-ctrexception-extract</property>
			<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
			<property name="RUN-ID">${INITIALIZE-RUN-RW.P_EXPORT_BATCH_ID_O}
			</property>
			<property name="WORKFLOW_RUN_ID">0</property>
		</generalProperties>
	</properties>

	<sequential name="CTR-EXCEPTION-EXTRACT-WF" id="CTR-EXCEPTION-EXTRACT-WF">

		<externalWorkflowReference name="INITIALIZE-RUN"
			id="INITIALIZE-RUN">
			<externalWorkflowCode>INITIALIZE-RUN</externalWorkflowCode>
			<inputProperties>
				<property name="EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
				<property name="SOURCE-SYSTEM">${IN-SOURCE-SYSTEM}</property>
				<property name="ROOT-WF-ID">${ROOT-WF-ID}</property>
				<property name="TARGET-SYSTEM">CTR</property>
				<property name="RUN-TYPE">BATCH</property>
				<property name="RUN-INSTANCE">${RUN-INSTANCE}</property>
				<property name="WORKFLOW-RUN-ID">${WORKFLOW_RUN_ID}</property>
			</inputProperties>
			<outputPropertyMapping>
				<mapping source="BUSINESS-DATE" target="BUSINESS-DATE" />
				<mapping source="BUSINESS-DATE-FORMATTED" target="BUSINESS-DATE-FORMATTED" />
				<mapping source="RUN-ID" target="P_EXPORT_BATCH_ID_O" />
				<mapping source="IS-MONTH-END" target="IS-MONTH-END" />
			</outputPropertyMapping>
		</externalWorkflowReference>

		<stage name="CTR-EXCEPTION-REPORT" id="CM-EXCEPTION-REPORT-T2E">
			<description>CTR exception report from target to export</description>
			<skipCondition> </skipCondition>
			<execDefinition>
				<dbProcedure name="CTRMSO.ETL_INVOKER_SP">
					<in>
						<param name="P_TYPE_NAME_I" type="STRING">ctr_exception_exp_tp</param>
						<param name="P_METHOD_NAME_I" type="STRING">pub_export_data</param>
						<param name="P_RUN_ID_I" type="NUMBER">${INITIALIZE-RUN.P_EXPORT_BATCH_ID_O}</param>
						<param name="P_STAGE_ID_I" type="STRING">TARGET</param>
						<param name="P_TASK_ID_I" type="STRING">CM-CTR-EXCEPTION-T2E</param>
						<param name="P_LOG_ID_I" type="STRING">1</param>
						<param name="P_BUSINESS_DATE_I" type="STRING">${BUSINESS-DATE}</param>
						<param name="P_SOURCE_SYSTEM_CD_I" type="STRING">${IN-SOURCE-SYSTEM}</param>
					</in>
					<out>
						<param name="P_RET_VALUE_O" type="NUMBER"></param>
						<param name="P_RET_MESSAGE_O" type="STRING"></param>
					</out>
				</dbProcedure>
			</execDefinition>
		</stage>

		<stage name="RUN-COMPLETE" id="RUN-COMPLETE">
			<description>Finalize the run and mark complete</description>
			<execDefinition>
				<dbProcedure name="CTRMSO.RUN_COMPLETION_SP">
					<in>
						<param name="P_RUN_ID_I" type="NUMBER">${INITIALIZE-RUN.P_EXPORT_BATCH_ID_O}</param>
						<param name="P_STAGE_ID_I" type="STRING">FINALIZE</param>
						<param name="P_TASK_ID_I" type="STRING">RUN-COMPLETE</param>
						<param name="P_LOG_ID_I" type="STRING">1</param>
						<param name="P_BUSSINESS_DATE_I" type="STRING">${BUSINESS-DATE}</param>
					</in>
					<out>
						<param name="P_RET_VALUE_O" type="NUMBER"></param>
						<param name="P_RET_MESSAGE_O" type="STRING"></param>
					</out>
				</dbProcedure>
			</execDefinition>
		</stage>
	</sequential>
</workflow>
	