<?xml version="1.0" encoding="UTF-8"?>
<workflow
    xsi:noNamespaceSchemaLocation="http://localhost:8080/maestro-orch-web/schemas/workflowdefn/workflowDefinition.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <name>ctr-cm-eod-epsilon-wf</name>
    <externalWorkflowCode>ctr-cm-eod-epsilon-wf</externalWorkflowCode>
    <finishOrchestrationASAPOnError>false</finishOrchestrationASAPOnError>
    <description>ctr-cm-eod-epsilon-wf ($LastChangedRevision: 4296 $)</description>
    
    <properties>
    	<inputProperties>
			<property name="WF-EOD-EOM-INDICATOR">D</property>
			<property name="RUN-INSTANCE">1</property>
		</inputProperties>
        <generalProperties>
        	<property name="ROOT-WF-ID">ctr-cm-eod-epsilon-wf</property>
        	<property name="WORKFLOW_RUN_ID">0</property>
        	<!-- Source Directories -->
            <property name="FTP-SOURCE-DIR">epsilon/inbox</property>
            <property name="HOLDING-DIR">${CTR_DATA_ROOT_PATH}/manual/epsilon</property>
            <property name="HOLDING-MATCH-PATTERN">.+_${WF-EOD-EOM-INDICATOR}_${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}_.+</property>
            
            <property name="SQLLDR-CONTROL-DIRECTORY">sqlldr</property>
            <property name="SQLLDR-DISCARD-DIR">data_in/discard</property>
            <property name="SQLLDR-LOG-DIRECTORY">data_in/ldrlog</property>
            <property name="SQLLDR-PROCESSING-SOURCE-DIR">data_in/infiles</property>
            <property name="SQLLDR-REJECT-DIRECTORY">data_in/reject</property>
            
            <property name="REPLICATE-SRC-IF-MONTH-END">T</property>
            <property name="DATA-CATEGORY-TYPE">CM</property>
            
            <!-- Source file naming pattern -->
            <property name="SRC-FILE-FILETYPE-PATTERN">[PT]?[_]?</property>
            <property name="SRC-FILE-FREQUENCY-PATTERN">${WF-EOD-EOM-INDICATOR}_</property>
            <property name="SRC-FILE-PRODUCTTYPE-PATTERN">[^_]*[_]?</property>
            <property name="SRC-FILE-SUFFIX-PATTERN-1">${SRC-FILE-PRODUCTTYPE-PATTERN}${SRC-FILE-FILETYPE-PATTERN}${SRC-FILE-FREQUENCY-PATTERN}${SRC-FILE-VERSION-PATTERN}</property>
            <property name="SRC-FILE-VERSION-PATTERN">(${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED})?_[0-9]{2,2}</property>
            
        </generalProperties>
    </properties>
    <sequential id="CTR-CAPITAL-MARKETS" name="CTR-CAPITAL-MARKETS">
        <externalWorkflowReference id="INITIALIZE-RUN" name="INITIALIZE-RUN">
            <externalWorkflowCode>INITIALIZE-RUN</externalWorkflowCode>
            <inputProperties>
                <property name="EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
                <property name="SOURCE-SYSTEM">EPSILON</property>
                <property name="ROOT-WF-ID">${ROOT-WF-ID}</property>
                <property name="TARGET-SYSTEM"/>
                <property name="RUN-TYPE" />
				<property name="RUN-INSTANCE">${RUN-INSTANCE}</property>
                <property name="WORKFLOW-RUN-ID">${WORKFLOW_RUN_ID}</property>
            </inputProperties>
            <outputPropertyMapping>
                <mapping source="BUSINESS-DATE" target="BUSINESS-DATE"/>
                <mapping source="BUSINESS-DATE-FORMATTED" target="BUSINESS-DATE-FORMATTED"/>
                <mapping source="RUN-ID" target="P_RUN_ID_O"/>
                <mapping source="IS-MONTH-END" target="IS-MONTH-END"/>
            </outputPropertyMapping>
        </externalWorkflowReference>
        <externalWorkflowReference id="PREPARE-SOURCE-FILES" name="PREPARE-SOURCE-FILES">
            <externalWorkflowCode>PREPARE-SOURCE-FILES</externalWorkflowCode>
            <inputProperties>
                <property name="FTP-SOURCE-DIR">${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</property>
                <property name="HOLDING-SOURCE-DIR">${HOLDING-DIR}</property>
                <property name="HOLDING-MATCH-PATTERN">${HOLDING-MATCH-PATTERN}</property>
                <property name="IS-MONTH-END">${INITIALIZE-RUN.IS-MONTH-END}</property>
                <property name="EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
            </inputProperties>
        </externalWorkflowReference>
        <stage id="INIT-COMPLETE-CHECK" name="INIT-COMPLETE-CHECK">
            <description>Verify if the common workflow steps completed</description>
            <stageFailure>
                <failureCondition>${INITIALIZE-RUN.P_RUN_ID_O} &lt;= 0 || "${CTR_APP_ROOT_PATH}" == '' || "${CTR_ROOT_PATH}" == ''|| "${CTR_FTP_ROOT_PATH}" == ''|| "${CTR_DATA_ROOT_PATH}" == ''|| "${CTR_CONFIG_ROOT_PATH}" == ''</failureCondition>
                <failureMessage>Common workflow initialization failed</failureMessage>
            </stageFailure>
            <execDefinition>
                <noOpExecDefinition>
                    <input>CHECK-IF-INIT-COMPLETE</input>
                    <numberOfTasks>1</numberOfTasks>
                    <numberOfInterimStatusResponses>1</numberOfInterimStatusResponses>
                    <durationBetweenEventsInMs>250</durationBetweenEventsInMs>
                    <outputPropertyName>output</outputPropertyName>
                </noOpExecDefinition>
            </execDefinition>
        </stage>
        <parallel id="EPSILON-WORKFLOWS" name="EPSILON-WORKFLOWS">
            <sequential id="EPSILON" name="EPSILON">
                <stage id="FILEWATCH-WF" name="FILEWATCH-WF">
                    <autoRetryConfiguration>
                        <delayBetweenAttemptsInMs>60000</delayBetweenAttemptsInMs>
                        <maximumNumberOfRetryAttempts>720</maximumNumberOfRetryAttempts>
                        <maximumRetryDurationInMs>43200000</maximumRetryDurationInMs>
                    </autoRetryConfiguration>
                    <execDefinition>
                        <pollingFileWatcher>
                            <watchedFiles>
                                <resource>
                                    <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                                    <searchPattern>EPSILON_PA_LegalEntity_${SRC-FILE-SUFFIX-PATTERN-1}.csv</searchPattern>
                                    <matchedUriOutputProperty>PA-LegalEntity-FILE</matchedUriOutputProperty>
                                </resource>
                                <resource>
                                    <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                                    <searchPattern>EPSILON_PA_LegalEntity_${SRC-FILE-SUFFIX-PATTERN-1}.mrk</searchPattern>
                                    <matchedUriOutputProperty>PA-LegalEntity-MRK</matchedUriOutputProperty>
                                </resource>
                                <resource>
                                    <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                                    <searchPattern>EPSILON_CM_Measures_${SRC-FILE-SUFFIX-PATTERN-1}.csv</searchPattern>
                                    <matchedUriOutputProperty>CM-Measures-FILE</matchedUriOutputProperty>
                                </resource>
                                <resource>
                                    <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                                    <searchPattern>EPSILON_CM_Measures_${SRC-FILE-SUFFIX-PATTERN-1}.mrk</searchPattern>
                                    <matchedUriOutputProperty>CM-Measures-MRK</matchedUriOutputProperty>
                                </resource>
                               <resource>
                                    <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                                    <searchPattern>EPSILON_CM_TRS_${SRC-FILE-SUFFIX-PATTERN-1}.csv</searchPattern>
                                    <matchedUriOutputProperty>CM-TRS-FILE</matchedUriOutputProperty>
                                </resource>
                                <resource>
                                    <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                                    <searchPattern>EPSILON_CM_TRS_${SRC-FILE-SUFFIX-PATTERN-1}.mrk</searchPattern>
                                    <matchedUriOutputProperty>CM-TRS-MRK</matchedUriOutputProperty>
                                </resource>
                                <resource>
                                    <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                                    <searchPattern>EPSILON_CM_LancelotDeal_${SRC-FILE-SUFFIX-PATTERN-1}.csv</searchPattern>
                                    <matchedUriOutputProperty>CM-LancelotDeal-FILE</matchedUriOutputProperty>
                                </resource>
                                <resource>
                                    <uri>${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</uri>
                                    <searchPattern>EPSILON_CM_LancelotDeal_${SRC-FILE-SUFFIX-PATTERN-1}.mrk</searchPattern>
                                    <matchedUriOutputProperty>CM-LancelotDeal-MRK</matchedUriOutputProperty>
                                </resource>

                            </watchedFiles>
                            <matchedCountProperty>matchedCount</matchedCountProperty>
                            <allowFileNotFound>false</allowFileNotFound>
                        </pollingFileWatcher>
                    </execDefinition>
                </stage>
                <parallel id="CHECKSUM" name="CHECKSUM">
                    <stage id="CHECKSUM-PA-LEGAL-ENTITY" name="CHECKSUM-PA-LEGAL-ENTITY">
                        <description>Validate checksum for file PA-LegalEntity</description>
                        <execDefinition>
                            <checksumValidation>
                                <sourceResource>
                                    <uri>${FILEWATCH-WF.PA-LegalEntity-FILE}</uri>
                                </sourceResource>
                                <markerResource>
                                    <uri>${FILEWATCH-WF.PA-LegalEntity-MRK}</uri>
                                </markerResource>
                                <checksumAlgorithm>SHA256</checksumAlgorithm>
                            </checksumValidation>
                        </execDefinition>
                    </stage>
                    <stage id="CHECKSUM-HL-MEASURES-FILE" name="CHECKSUM-HL-MEASURES-FILE">
                        <description>Validate checksum for file HL-Measures</description>
                        <execDefinition>
                            <checksumValidation>
                                <sourceResource>
                                    <uri>${FILEWATCH-WF.CM-Measures-FILE}</uri>
                                </sourceResource>
                                <markerResource>
                                    <uri>${FILEWATCH-WF.CM-Measures-MRK}</uri>
                                </markerResource>
                                <checksumAlgorithm>SHA256</checksumAlgorithm>
                            </checksumValidation>
                        </execDefinition>
                    </stage>
                    <stage id="CHECKSUM-CM-TRS-FILE" name="CHECKSUM-CM-TRS-FILE">
                        <description>Validate checksum for file CM-TRS</description>
                        <execDefinition>
                            <checksumValidation>
                                <sourceResource>
                                    <uri>${FILEWATCH-WF.CM-TRS-FILE}</uri>
                                </sourceResource>
                                <markerResource>
                                    <uri>${FILEWATCH-WF.CM-TRS-MRK}</uri>
                                </markerResource>
                                <checksumAlgorithm>SHA256</checksumAlgorithm>
                            </checksumValidation>
                        </execDefinition>
                    </stage>
                    <stage id="CHECKSUM-CM-LANCELOTDEAL-FILE" name="CHECKSUM-CM-LANCELOTDEAL-FILE">
                        <description>Validate checksum for file CM-LancelotDeal</description>
                        <execDefinition>
                            <checksumValidation>
                                <sourceResource>
                                    <uri>${FILEWATCH-WF.CM-LancelotDeal-FILE}</uri>
                                </sourceResource>
                                <markerResource>
                                    <uri>${FILEWATCH-WF.CM-LancelotDeal-MRK}</uri>
                                </markerResource>
                                <checksumAlgorithm>SHA256</checksumAlgorithm>
                            </checksumValidation>
                        </execDefinition>
                    </stage>
									</parallel>
								<externalWorkflowReference id="PREPARE-LOAD-WF" name="PREPARE-LOAD-WF">
                    <skipCondition>${FILEWATCH-WF.matchedCount} == 0</skipCondition>
                    <externalWorkflowCode>PREPARE-CM-LOAD-WF</externalWorkflowCode>
                    <inputProperties>
                        <property name="SOURCE-SYSTEM">EPSILON</property>
                        <property name="SOURCE-SYSTEM-LC">epsilon</property>
												<property name="CTR-SOURCE-SYSTEM-CODE">EPSILON</property>
                        <property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
                        <property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
                        <property name="FTP-SOURCE-DIR">${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</property>
                        <property name="PROCESSING-DIR">${CTR_DATA_INBOUND_PATH}</property>
                        <property name="HOLDING-SOURCE-DIR">${HOLDING-DIR}</property>
                        <property name="REPLICATE-IF-MONTH-END">${REPLICATE-SRC-IF-MONTH-END}</property>
                        <property name="IS-MONTH-END">${INITIALIZE-RUN.IS-MONTH-END}</property>
                        <property name="EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
                    </inputProperties>
                </externalWorkflowReference>
                <parallel id="LOAD" name="LOAD-SOURCE-FILES">
                    <skipCondition>${FILEWATCH-WF.matchedCount} == 0</skipCondition>
                    <externalWorkflowReference id="LOAD-LEGAL-ENTITY" name="LOAD-LEGAL-ENTITY">
                        <externalWorkflowCode>LOAD-FILE-WF</externalWorkflowCode>
                        <inputProperties>
                            <property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
                            <property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
                            <property name="SOURCE-FILE">${FILEWATCH-WF.PA-LegalEntity-FILE}</property>
                            <property name="PROCESSING-SOURCE-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR}</property>
                            <property name="CONTROL-PATH">${CTR_CONFIG_ROOT_PATH}/${SQLLDR-CONTROL-DIRECTORY}</property>
                            <property name="DISCARD-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-DISCARD-DIR}</property>
                            <property name="REJECT-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-REJECT-DIRECTORY}</property>
                            <property name="LOG-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-LOG-DIRECTORY}</property>
                            <property name="DATA-CATEGORY">${DATA-CATEGORY-TYPE}</property>
                            <property name="DELIMITER">,</property>
                        </inputProperties>
                    </externalWorkflowReference>
                    <externalWorkflowReference id="LOAD-MEASURES" name="LOAD-MEASURES">
                        <externalWorkflowCode>LOAD-FILE-WF</externalWorkflowCode>
                        <inputProperties>
                            <property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
                            <property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
                            <property name="SOURCE-FILE">${FILEWATCH-WF.CM-Measures-FILE}</property>
                            <property name="PROCESSING-SOURCE-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR}</property>
                            <property name="CONTROL-PATH">${CTR_CONFIG_ROOT_PATH}/${SQLLDR-CONTROL-DIRECTORY}</property>
                            <property name="DISCARD-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-DISCARD-DIR}</property>
                            <property name="REJECT-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-REJECT-DIRECTORY}</property>
                            <property name="LOG-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-LOG-DIRECTORY}</property>
                            <property name="DATA-CATEGORY">${DATA-CATEGORY-TYPE}</property>
                            <property name="DELIMITER">,</property>
                        </inputProperties>
                    </externalWorkflowReference>
                    <externalWorkflowReference id="LOAD-TRS" name="LOAD-TRS">
                        <externalWorkflowCode>LOAD-FILE-WF</externalWorkflowCode>
                        <inputProperties>
                            <property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
                            <property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
                            <property name="SOURCE-FILE">${FILEWATCH-WF.CM-TRS-FILE}</property>
                            <property name="PROCESSING-SOURCE-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR}</property>
                            <property name="CONTROL-PATH">${CTR_CONFIG_ROOT_PATH}/${SQLLDR-CONTROL-DIRECTORY}</property>
                            <property name="DISCARD-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-DISCARD-DIR}</property>
                            <property name="REJECT-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-REJECT-DIRECTORY}</property>
                            <property name="LOG-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-LOG-DIRECTORY}</property>
                            <property name="DATA-CATEGORY">${DATA-CATEGORY-TYPE}</property>
                            <property name="DELIMITER">,</property>
                        </inputProperties>
                    </externalWorkflowReference>
                    <externalWorkflowReference id="LOAD-LANCELOTDEAL" name="LOAD-LANCELOTDEAL">
                        <externalWorkflowCode>LOAD-FILE-WF</externalWorkflowCode>
                        <inputProperties>
                            <property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
                            <property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
                            <property name="SOURCE-FILE">${FILEWATCH-WF.CM-LancelotDeal-FILE}</property>
                            <property name="PROCESSING-SOURCE-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-PROCESSING-SOURCE-DIR}</property>
                            <property name="CONTROL-PATH">${CTR_CONFIG_ROOT_PATH}/${SQLLDR-CONTROL-DIRECTORY}</property>
                            <property name="DISCARD-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-DISCARD-DIR}</property>
                            <property name="REJECT-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-REJECT-DIRECTORY}</property>
                            <property name="LOG-PATH">${CTR_DATA_ROOT_PATH}/${SQLLDR-LOG-DIRECTORY}</property>
                            <property name="DATA-CATEGORY">${DATA-CATEGORY-TYPE}</property>
                            <property name="DELIMITER">,</property>
                        </inputProperties>
                    </externalWorkflowReference>
                </parallel>
                <externalWorkflowReference id="CM-ETL-WF" name="CM-ETL-WF">
                    <skipCondition>${FILEWATCH-WF.matchedCount} == 0</skipCondition>
                    <externalWorkflowCode>CM-ETL-WF</externalWorkflowCode>
                    <inputProperties>
                        <property name="SOURCE-SYSTEM">EPSILON</property>
                        <property name="SOURCE-SYSTEM-LC">epsilon</property>
                        <property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
                        <property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
                        <property name="EOD-EOM-IND">${WF-EOD-EOM-INDICATOR}</property>
                    </inputProperties>
                </externalWorkflowReference>
                <externalWorkflowReference name="CM-CSM-ENRICHMENT-WF" id="CM-CSM-ENRICHMENT-WF">
					<skipCondition>${FILEWATCH-WF.matchedCount} == 0</skipCondition>
					<externalWorkflowCode>CM-CSM-ENRICHMENT-WF</externalWorkflowCode>
					<inputProperties>
						<property name="SOURCE-SYSTEM">EPSILON</property>
						<property name="SOURCE-SYSTEM-LC">epsilon</property>
						<property name="WF-EOD-EOM-INDICATOR">${WF-EOD-EOM-INDICATOR}</property>
						<property name="RUN-ID" >${INITIALIZE-RUN.P_RUN_ID_O}</property>
						<property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
						<property name="BUSINESS-DATE-FORMATTED">${INITIALIZE-RUN.BUSINESS-DATE-FORMATTED}</property>
						<property name="IS-MONTH-END">${INITIALIZE-RUN.IS-MONTH-END}</property>
					</inputProperties>
				</externalWorkflowReference>
            </sequential>
        </parallel>
        <externalWorkflowReference id="COMPLETE-RUN" name="FINALIZE-RUN">
            <description>Finalize the run and mark complete</description>
            <externalWorkflowCode>FINALIZE-RUN</externalWorkflowCode>
            <inputProperties>
                <property name="SOURCE-SYSTEM">EPSILON</property>
                <property name="RUN-ID">${INITIALIZE-RUN.P_RUN_ID_O}</property>
                <property name="BUSINESS-DATE">${INITIALIZE-RUN.BUSINESS-DATE}</property>
                <property name="SRC-FILE-SUFFIX-PATTERN">${SRC-FILE-SUFFIX-PATTERN-1}</property>
                <property name="FTP-SOURCE-DIR">${CTR_FTP_ROOT_PATH}/${FTP-SOURCE-DIR}</property>
            </inputProperties>
        </externalWorkflowReference>
    </sequential>
</workflow>
