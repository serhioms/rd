<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- $Id: CM-EXTRACT-TO-LANCELOT.xml 4062 2016-06-22 13:28:43Z gmusial $
	 Maestro version: 1.16.0 -->

<workflow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="workflowDefinition.xsd">
	<name>CM-EXTRACT-TO-LANCELOT</name> 
  	<externalWorkflowCode>CM-EXTRACT-TO-LANCELOT</externalWorkflowCode> 
  	<finishOrchestrationASAPOnError>false</finishOrchestrationASAPOnError> 
	<description>CM-EXTRACT-TO-LANCELOT ($LastChangedRevision: 4062 $)</description>

	<properties>
		<inputProperties>
			<property name="SOURCE-SYSTEM" />
			<property name="RUN-ID" />
			<property name="BUSINESS-DATE" />
			<property name="EOD-EOM-IND" />
		</inputProperties>
	</properties>

	<!-- DELIVERY PHASE -->

	<sequential name="EXTRACT-TO-LANCELOT" id="EXTRACT-TO-LANCELOT">
	
		<!-- LANCELOT TRADE EXPORT  -->

		<stage name="GENERATE-LANCELOT-TRADE-FILE" id="GEN-LANCELOT-TRADE">
			<description>Generate Lancelot Trade file</description>
			<stageFailure>
				<failureCondition><![CDATA[${GEN-LANCELOT-TRADE.exitCode} != 0]]></failureCondition>
				<!-- <failureMessage>FSM-(${GEN-LANCELOT-TRADE.exitCode}) : Error while generating Party file. See FSM log for details.</failureMessage>-->
				<failureMessage>CTR Issue, please check with support team.</failureMessage>
			</stageFailure>
			<execDefinition>
				<callExternalProcess>
					<commandLine>${CTR_APP_ROOT_PATH}/script/extractLancelotTbl.${SHELL_SCRIPT_EXTENSION} ${CTR_DB_SCHEMA} ${SHELL_COMMA_DELIM_PARAM} ${RUN-ID} ${SOURCE-SYSTEM}</commandLine>
					<workingDirectory>${CTR_APP_ROOT_PATH}/script/</workingDirectory>
					<exitCodeProperty>exitCode</exitCodeProperty>
				</callExternalProcess>
			</execDefinition>
		</stage>
		
		<stage name="GET-LANCELOT-EXTRACT-VERSION" id="GET-LANCELOT-EXTRACT-VERSION">
			<execDefinition>
				 <dbFunction name="CTRMSO.RUN_PKG.GET_VERSION_SP">
                    <in>
                        <param name="P_BATCH_ID_I" type="STRING">${RUN-ID}</param>
                    </in>
                    <result name="version" type="NUMBER"/>
                </dbFunction>
			</execDefinition>
		</stage>

		<stage name="SET-LANCELOT-SFTP-TIMESTAMP" id="SET-LANCELOT-SFTP-TIMESTAMP">
			<execDefinition>
				 <dbProcedure name="CTRMSO.LANCELOT_EXP_HELPER_PKG.SET_SFTP_TSTMP_SP">
                    <in>
                        <param name="P_BATCH_ID_I" type="NUMBER">${RUN-ID}</param>
                    </in>
                </dbProcedure>
			</execDefinition>
		</stage>			

		<stage name="SEND-TO-LANCELOT" id="SEND-TO-LANCELOT">
			<skipCondition>'${LANCELOT_DESTINATION_URI}' == 'NONE'</skipCondition>
			<execDefinition>
				<fileTransfer>
					<transfer>
						<sourceResource>
							<uri>${CTR_OUTBOUND_PATH}/lancelot</uri>
							<searchPattern>.*_${BUSINESS-DATE}_${GET-LANCELOT-EXTRACT-VERSION.version}.(csv.mrk|csv|mrk)</searchPattern>
							<matchedUriOutputProperty>LANCELOT-FILES</matchedUriOutputProperty>
						</sourceResource>
						<targetResource>
							<uri>${LANCELOT_DESTINATION_URI}</uri>
						</targetResource>
					</transfer>
					<transferCountProperty>transferCount</transferCountProperty>
				</fileTransfer>
			</execDefinition>
		</stage>	
		<stage name="SEND-DONEFILE-TO-LANCELOT" id="SEND-DONEFILE-TO-LANCELOT">	
		   <skipCondition>'${LANCELOT_DESTINATION_URI}' == 'NONE'</skipCondition>
			<execDefinition>
				<fileTransfer>
					<transfer>
						<sourceResource>
							<uri>${CTR_OUTBOUND_PATH}/lancelot</uri>
							<searchPattern>.*_${BUSINESS-DATE}_${GET-LANCELOT-EXTRACT-VERSION.version}\.txt</searchPattern>
							<matchedUriOutputProperty>LANCELOT-FILES</matchedUriOutputProperty>
						</sourceResource>
						<targetResource>
							<uri>${LANCELOT_DESTINATION_URI}</uri>
						</targetResource>
					</transfer>
					<transferCountProperty>transferCount</transferCountProperty>
				</fileTransfer>
			</execDefinition>
		</stage>
		
		<stage name="SEND-TO-LANCELOT-UAT" id="SEND-TO-LANCELOT-UAT">
			<skipCondition>'${LANCELOT_UAT_DESTINATION_URI}' == 'NONE'</skipCondition>
			<execDefinition>
				<fileTransfer>
					<transfer>
						<sourceResource>
							<uri>${CTR_OUTBOUND_PATH}/lancelot_uat</uri>
							<searchPattern>.*_${BUSINESS-DATE}_${GET-LANCELOT-EXTRACT-VERSION.version}.(csv.mrk|csv|mrk)</searchPattern>
							<matchedUriOutputProperty>LANCELOT-FILES</matchedUriOutputProperty>
						</sourceResource>
						<targetResource>
							<uri>${LANCELOT_UAT_DESTINATION_URI}</uri>
						</targetResource>
					</transfer>
					<transferCountProperty>transferCount</transferCountProperty>
				</fileTransfer>
			</execDefinition>
		</stage>	
		<stage name="SEND-DONEFILE-TO-LANCELOT-UAT" id="SEND-DONEFILE-TO-LANCELOT-UAT">	
		   <skipCondition>'${LANCELOT_UAT_DESTINATION_URI}' == 'NONE'</skipCondition>
			<execDefinition>
				<fileTransfer>
					<transfer>
						<sourceResource>
							<uri>${CTR_OUTBOUND_PATH}/lancelot_uat</uri>
							<searchPattern>.*_${BUSINESS-DATE}_${GET-LANCELOT-EXTRACT-VERSION.version}\.txt</searchPattern>
							<matchedUriOutputProperty>LANCELOT-FILES</matchedUriOutputProperty>
						</sourceResource>
						<targetResource>
							<uri>${LANCELOT_UAT_DESTINATION_URI}</uri>
						</targetResource>
					</transfer>
					<transferCountProperty>transferCount</transferCountProperty>
				</fileTransfer>
			</execDefinition>
		</stage>
		
		<!-- BEGIN : TRANSFER SOURCE FILES TO DS -->
		<externalWorkflowReference name="TRANSFER-DATA-FILES-TO-EDL" id="TRANSFER-DATA-FILES-TO-EDL">
			<skipCondition>'${EDL_COPY_URI}' == 'NONE' </skipCondition>
			<externalWorkflowCode>EXPORT-SRC-FILES-WF</externalWorkflowCode>
			<inputProperties>
				<property name="SOURCE-SYSTEM">LANCELOT</property>
				<property name="SOURCE-SYSTEM-LC">lancelot</property>
				<property name="DEST_URI">${EDL_COPY_URI}/lancelot</property>
				<property name="SRC_URI">${CTR_OUTBOUND_PATH}/lancelot/</property>
				<property name="SRCH_PATTERN">.*_${BUSINESS-DATE}.*</property>
				<property name="DEST_SYSTEM">EDL</property>
			</inputProperties>
		</externalWorkflowReference>
		<externalWorkflowReference name="TRANSFER-MRK-FILES-TO-EDL" id="TRANSFER-MRK-FILES-TO-EDL">
			<externalWorkflowCode>EXPORT-SRC-FILES-WF</externalWorkflowCode>
			<inputProperties>
				<property name="SOURCE-SYSTEM">LANCELOT</property>
				<property name="SOURCE-SYSTEM-LC">lancelot</property>
				<property name="DEST_URI">${EDL_DESTINATION_URI}</property>
				<property name="SRC_URI">${CTR_OUTBOUND_PATH}/lancelot/</property>
				<property name="SRCH_PATTERN">.*_${BUSINESS-DATE}_.*.mrk</property>
				<property name="DEST_SYSTEM">EDL</property>
			</inputProperties>
		</externalWorkflowReference>
		<externalWorkflowReference name="TRANSFER-DATA-FILES-TO-VOLCKER" id="TRANSFER-DATA-FILES-TO-VOLCKER">
			<externalWorkflowCode>EXPORT-SRC-FILES-WF</externalWorkflowCode>
			<inputProperties>
				<property name="SOURCE-SYSTEM">LANCELOT</property>
				<property name="SOURCE-SYSTEM-LC">lancelot</property>
				<property name="DEST_URI">${VOLCKER_DESTINATION_URI}</property>
				<property name="SRC_URI">${CTR_OUTBOUND_PATH}/lancelot/</property>
				<property name="SRCH_PATTERN">.*_${BUSINESS-DATE}.*</property>
				<property name="DEST_SYSTEM">VOLCKER</property>
			</inputProperties>
		</externalWorkflowReference>
		<!-- END : TRANSFER SOURCE FILES TO DS -->
		
		
	</sequential>

</workflow>
	