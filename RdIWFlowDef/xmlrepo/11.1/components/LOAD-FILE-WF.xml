<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- $Id: LOAD-FILE-WF.xml 3690 2016-06-01 20:44:07Z gmusial $ Maestro version: 
	1.16.0 -->

<workflow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="workflowDefinition.xsd">
	<name>LOAD-FILE-WF</name>
	<externalWorkflowCode>LOAD-FILE-WF</externalWorkflowCode>
	<finishOrchestrationASAPOnError>false</finishOrchestrationASAPOnError>
	<description>LOAD-FILE-WF ($LastChangedRevision: 3690 $)</description>

	<properties>
		<inputProperties>
			<property name="RUN-ID" />
			<property name="BUSINESS-DATE" />
			<property name="SOURCE-FILE" />
			<property name="PROCESSING-SOURCE-PATH" />
			<property name="CONTROL-PATH" />
			<property name="DISCARD-PATH" />
			<property name="REJECT-PATH" />
			<property name="LOG-PATH" />
			<property name="DATA-CATEGORY" />
			<property name="DELIMITER">,</property>
		</inputProperties>
		<generalProperties>
			<property name="SOURCE-SYSTEM">${GET-FILE-DATA.P_APP_CODE_UC_O}</property>
			<property name="#fixedFileName">NONE</property>
			<property name="#badFileName">NONE</property>
		</generalProperties>
	</properties>
		
	<sequential id="LOAD-FILE" name="LOAD-FILE">
	
		<stage name="FORMAT-BUSINESS-DATE" id="FORMAT-BUSINESS-DATE">
				<description>Format the business date</description>
				<stageFailure>
					<failureCondition><![CDATA['${FORMAT-BUSINESS-DATE.result}' == '']]></failureCondition>
					<failureMessage>FORMAT-BUSINESS-DATE returned empty date</failureMessage>
				</stageFailure>
				<execDefinition>
					<dbFunction name="CTRMSO.FORMAT_DATE_FN">
						<in>
							<param name="DATE_I" type="STRING">${BUSINESS-DATE}</param>
							<param name="FORMAT_I" type="STRING">yyyymmdd</param>
						</in>
						<result name="result" type="STRING"></result>
					</dbFunction>
				</execDefinition>
			</stage>
	
	
		<stage id="GET-FILE-VERSION" name="GET-FILE-VERSION">
			<execDefinition>
				<javaExtension>
					<javaExtensionExecutorClassName>com.bns.ctr.maestro.javaexec.FileVersionRetriever</javaExtensionExecutorClassName>
					<simpleProperties>
						<properties>
							<simpleProperty name="dataCategory">${DATA-CATEGORY}</simpleProperty>
							<simpleProperty name="filePath">${PROCESSING-SOURCE-PATH}</simpleProperty>
							<simpleProperty name="fileName">${SOURCE-FILE}</simpleProperty>
							<simpleProperty name="dlrName">${DELIMITER}</simpleProperty>
							<simpleProperty name="controlPath">${CONTROL-PATH}</simpleProperty>
						</properties>
					</simpleProperties>
					<javaExtensionOutputPropertyNames>
						<propertyName>fileVersion</propertyName>
						<propertyName>isHolidayFile</propertyName>
						<propertyName>headerName</propertyName>
						<propertyName>originalFileVersion</propertyName>
					</javaExtensionOutputPropertyNames>
				</javaExtension>
			</execDefinition>
		</stage>
		<stage name="GET-FILE-DATA" id="GET-FILE-DATA">
			<description>Retrieve source file data and SQLLoader param info</description>
			<execDefinition>
				<dbProcedure name="CTRMSO.PARSE_FILE_NAME_SP">
					<in>
						<param name="P_FILENAME_I" type="STRING">${SOURCE-FILE}</param>
						<param name="P_HEADERNAME_I" type="STRING">${GET-FILE-VERSION.headerName}</param>
						<param name="P_RUN_ID_I" type="STRING">${RUN-ID}</param>
					</in>
					<out>
						<param name="P_FILENAME_O" type="STRING"></param>
						<param name="P_APP_CODE_UC_O" type="STRING"></param>
						<param name="P_APP_CODE_LC_O" type="STRING"></param>
						<param name="P_SUBJECT_AREA_O" type="STRING"></param>
						<param name="P_PRODUCT_TYPE_O" type="STRING"></param>
						<param name="P_SRC_FILE_TYPE_O" type="STRING"></param>
						<param name="P_FREQUENCY_O" type="STRING"></param>
						<param name="P_DATE_O" type="STRING"></param>
						<param name="P_VERSION_O" type="STRING"></param>
						<param name="P_EXTRACT_TYPE_O" type="STRING"></param>
						<param name="P_FILE_TYPE_O" type="STRING"></param>
						<param name="P_DATA_FILE_O" type="STRING"></param>
						<param name="P_CTRL_FILE_TEMPLATE_O" type="STRING"></param>
						<param name="P_DISCARD_FILE_O" type="STRING"></param>
						<param name="P_REJECT_FILE_O" type="STRING"></param>
						<param name="P_LOG_FILE_O" type="STRING"></param>
						<param name="P_CTRL_FILE_O" type="STRING"></param>
						<param name="P_LANDING_TABLE_FILE_O" type="STRING"></param>
						<param name="P_REJ_XML_FILE_TEMPLATE_O" type="STRING"></param>
						<param name="P_REJ_XML_FILE_O" type="STRING"></param>
						<param name="P_BAD_CTRL_FILE_TEMPLATE_O" type="STRING"></param>
						<param name="P_BAD_CTRL_FILE_O" type="STRING"></param>
						<param name="P_BAD_LANDING_TABLE_FILE_O" type="STRING"></param>
						<param name="P_HAS_HEADER_O" type="STRING"></param>
					</out>
				</dbProcedure>
			</execDefinition>
		</stage>
				<stage name="PREPARE-CTRL-FILE" id="PREPARE-CTRL-FILE">
					<description>Prepare the sqlldr ctrl file - substitubes source system code token</description>
					<skipCondition><![CDATA['${GET-FILE-VERSION.isHolidayFile}' == 'true' || ( '${GET-FILE-VERSION.headerName}' == 'EMPTY' && '${GET-FILE-DATA.P_HAS_HEADER_O}' == 'Y' )]]></skipCondition>
					<stageFailure>
						<failureCondition>${PREPARE-CTRL-FILE.exitCode} != 0</failureCondition>
						<failureMessage>CTL-FILE-TOKEN-HANDLER-(${PREPARE-CTRL-FILE.exitCode}) 
							:Error while preparing control file. See ctrCTLfileTokenHandler log for details.</failureMessage>
					</stageFailure>
					<execDefinition>
						<callExternalProcess>
							<commandLine>${CTR_APP_ROOT_PATH}/script/ctrCTLfileTokenHandler.${SHELL_SCRIPT_EXTENSION} ${CONTROL-PATH}/${GET-FILE-DATA.P_CTRL_FILE_TEMPLATE_O} ${CONTROL-PATH}/${GET-FILE-DATA.P_CTRL_FILE_O} ${SOURCE-SYSTEM} ${GET-FILE-VERSION.originalFileVersion}</commandLine>
							<workingDirectory>${CTR_APP_ROOT_PATH}/script/</workingDirectory>
							<exitCodeProperty>exitCode</exitCodeProperty>
						</callExternalProcess>
					</execDefinition>
				</stage>
				<stage name="PREPARE-CTRL-XML-FILE" id="PREPARE-CTRL-XML-FILE">
					<description>Prepare the sqlldr ctrl xml file - substitutes source system code token</description>
					<skipCondition><![CDATA['${GET-FILE-VERSION.isHolidayFile}' == 'true' || ( '${GET-FILE-VERSION.headerName}' == 'EMPTY' && '${GET-FILE-DATA.P_HAS_HEADER_O}' == 'Y' )]]></skipCondition>
					<stageFailure>
						<failureCondition>${PREPARE-CTRL-XML-FILE.exitCode} != 0</failureCondition>
						<failureMessage>CTL-FILE-TOKEN-HANDLER-(${PREPARE-CTRL-FILE.exitCode}) 
							:Error while preparing control xml file. See ctrCTLfileTokenHandler log for details.</failureMessage>
					</stageFailure>
					<execDefinition>
						<callExternalProcess>
							<commandLine>${CTR_APP_ROOT_PATH}/script/ctrCTLfileTokenHandler.${SHELL_SCRIPT_EXTENSION} ${CONTROL-PATH}/${GET-FILE-DATA.P_REJ_XML_FILE_TEMPLATE_O} ${CONTROL-PATH}/${GET-FILE-DATA.P_REJ_XML_FILE_O} ${SOURCE-SYSTEM} ${GET-FILE-VERSION.originalFileVersion}</commandLine>
							<workingDirectory>${CTR_APP_ROOT_PATH}/script/</workingDirectory>
							<exitCodeProperty>exitCode</exitCodeProperty>
						</callExternalProcess>
					</execDefinition>
				</stage>
				<stage id="GET-ROW-COUNT" name="GET-ROW-COUNT">
					<skipCondition><![CDATA['${GET-FILE-VERSION.isHolidayFile}' == 'true' || ( '${GET-FILE-VERSION.headerName}' == 'EMPTY' && '${GET-FILE-DATA.P_HAS_HEADER_O}' == 'Y' )]]></skipCondition>
					<execDefinition>
						<javaExtension>
							<javaExtensionExecutorClassName>com.bns.ctr.maestro.javaexec.RetrieveRowNumbers</javaExtensionExecutorClassName>
							<simpleProperties>
								<properties>
									<simpleProperty name="filePath">${PROCESSING-SOURCE-PATH}</simpleProperty>
									<simpleProperty name="fileName">${SOURCE-FILE}</simpleProperty>
									<simpleProperty name="xmlControlFile">${CONTROL-PATH}/${GET-FILE-DATA.P_REJ_XML_FILE_O}</simpleProperty>
								</properties>
							</simpleProperties>
							<javaExtensionOutputPropertyNames>
								<propertyName>totalNoOfRows</propertyName>
							</javaExtensionOutputPropertyNames>
						</javaExtension>
					</execDefinition>
				</stage>
				
				<stage id="GET-FILE-CREATE-TIME" name="GET-FILE-CREATE-TIME">
					<execDefinition>
						<javaExtension>
							<javaExtensionExecutorClassName>com.bns.ctr.maestro.javaexec.FileTimeStampMapReader</javaExtensionExecutorClassName>
							<simpleProperties>
								<properties>
									<simpleProperty name="fileMetaDataMap">${PROCESSING-SOURCE-PATH}/${SOURCE-SYSTEM}_METADATA_${FORMAT-BUSINESS-DATE.result}.txt</simpleProperty>
									<simpleProperty name="srcFileName">${SOURCE-FILE}</simpleProperty>
								</properties>
							</simpleProperties>
							<javaExtensionOutputPropertyNames>
								<propertyName>fileCreateTime</propertyName>
							</javaExtensionOutputPropertyNames>
						</javaExtension>
					</execDefinition>
				</stage>
				
		<parallel id="LOAD-FILE-PARA" name="LOAD-FILE-PARA">
			<skipCondition><![CDATA['${GET-FILE-VERSION.isHolidayFile}' == 'true' || ( '${GET-FILE-VERSION.headerName}' == 'EMPTY' && '${GET-FILE-DATA.P_HAS_HEADER_O}' == 'Y' )]]></skipCondition>
			<sequential id="LOAD-FILE-START" name="LOAD-FILE-START">
				<stage id="READ-LANDING-TABLE-FILE" name="READ-LANDING-TABLE-FILE">
					<description>Read the landing table file to get bad landing table delimited list</description>
					<execDefinition>
						<javaExtension>
							<javaExtensionExecutorClassName>com.bns.ctr.maestro.javaexec.FileContentRetriever</javaExtensionExecutorClassName>
							<simpleProperties>
								<properties>
									<simpleProperty name="filePath">${CONTROL-PATH}/${GET-FILE-DATA.P_LANDING_TABLE_FILE_O}</simpleProperty>
								</properties>
							</simpleProperties>
							<javaExtensionOutputPropertyNames>
								<propertyName>fileContents</propertyName>
							</javaExtensionOutputPropertyNames>
							<outputPropertyMapping>
								<mapping source="fileContents" target="#LANDING-TABLE-LIST"/>
							</outputPropertyMapping>
						</javaExtension>
					</execDefinition>
				</stage>

				<stage name="GET-FILE-ID" id="GET-FILE-ID">
					<description>Retrieves the file ID for the preprocessor</description>
					<execDefinition>
						<dbProcedure name="CTRMSO.FILE_PKG.CREATE_FILE_SP">
							<in>
								<param name="P_FILENAME_I" type="STRING">${PROCESSING-SOURCE-PATH}/${GET-FILE-DATA.P_DATA_FILE_O}</param>
								<param name="P_ROWCOUNT_I" type="NUMBER">${GET-ROW-COUNT.totalNoOfRows}</param>
								<param name="P_HEADER_VERSION_I" type="STRING">${GET-FILE-VERSION.fileVersion}</param>
								<param name="P_ORIGINAL_HEADER_VERSION_I" type="STRING">${GET-FILE-VERSION.originalFileVersion}</param>
								<param name="P_SUBJECT_AREA_CD_I" type="STRING">${GET-FILE-DATA.P_SUBJECT_AREA_O}</param>
								<param name="P_RUN_ID_I" type="NUMBER">${RUN-ID}</param>
								<param name="P_STAGE_ID_I" type="STRING">LANDING</param>
								<param name="P_TASK_ID_I" type="STRING">${GET-FILE-DATA.P_SUBJECT_AREA_O}-${GET-FILE-DATA.P_PRODUCT_TYPE_O}-GET-FILE-ID</param>
								<param name="P_LOG_ID_I" type="STRING">1</param>
								<param name="P_SOURCE_SYSTEM_CD_I" type="STRING">${SOURCE-SYSTEM}</param>
								<param name="P_LANDING_TABLE_LIST_I" type="STRING">${#LANDING-TABLE-LIST}</param>
								<param name="P_FILE_CREATE_TIME_I" type="STRING">${GET-FILE-CREATE-TIME.fileCreateTime}</param>
							</in>
							<out>
								<param name="P_DW_FILE_ID_O" type="NUMBER"></param>
							</out>
						</dbProcedure>
					</execDefinition>
				</stage>

				<stage name="PREPROCESS-FILE" id="PREPROCESS-FILE">
					<description>Preprocess the source file - Prepend file id and line number to each line in the source file</description>
					<stageFailure>
						<failureCondition>${PREPROCESS-FILE.exitCode} != 0</failureCondition>
						<failureMessage>PREPROCESSOR-(${PREPROCESS-FILE.exitCode}) :Error 
							while preprocessing file. See preprocessor log for details.</failureMessage>
					</stageFailure>
					<execDefinition>
						<callExternalProcess>
							<commandLine>${CTR_APP_ROOT_PATH}/script/src_file_preprocess.${SHELL_SCRIPT_EXTENSION} ${GET-FILE-ID.P_DW_FILE_ID_O} 0 ${DELIMITER} ${PROCESSING-SOURCE-PATH}/${GET-FILE-DATA.P_FILENAME_O} ${PROCESSING-SOURCE-PATH}/${GET-FILE-DATA.P_DATA_FILE_O} ${CONTROL-PATH}/${GET-FILE-DATA.P_REJ_XML_FILE_O}</commandLine>
							<workingDirectory>${CTR_APP_ROOT_PATH}/script/</workingDirectory>
							<exitCodeProperty>exitCode</exitCodeProperty>
						</callExternalProcess>
					</execDefinition>
				</stage>
				<stage name="TRUNCATE-LANDING-FOR-ACBS-LO-ONLY" id="TRUNCATE-LANDING-ACBS">
					<description>Conditionally truncate landing tables for ACBS source system only</description>
					<skipCondition><![CDATA['${SOURCE-SYSTEM}' != 'ACBS' || '${GET-FILE-DATA.P_SUBJECT_AREA_O}' != 'LO']]></skipCondition>
					<execDefinition>
						<dbProcedure name="CTRMSO.ETL_INVOKER_SP">
							<in>
								<param name="P_TYPE_NAME_I" type="STRING">arrangement_loan_tp</param>
								<param name="P_METHOD_NAME_I" type="STRING">pub_trunc_pre_land_partition</param>
								<param name="P_RUN_ID_I" type="NUMBER">${RUN-ID}</param>
								<param name="P_STAGE_ID_I" type="STRING">LANDING</param>
								<param name="P_TASK_ID_I" type="STRING">TRUNCATE-LANDING-ACBS</param>
								<param name="P_LOG_ID_I" type="STRING">1</param>
								<param name="P_BUSINESS_DATE_I" type="STRING">${BUSINESS-DATE}</param>
								<param name="P_SOURCE_SYSTEM_CD_I" type="STRING">${SOURCE-SYSTEM}</param>
							</in>
							<out>
								<param name="P_RET_VALUE_O" type="NUMBER"></param>
								<param name="P_RET_MESSAGE_O" type="STRING"></param>
							</out>
						</dbProcedure>
					</execDefinition>
				</stage>

				<stage name="SQLLOADER-LOAD-FILE" id="SQLLDR-LOAD">
					<description>Loads source file</description>
					<stageFailure>
						<failureCondition><![CDATA[${SQLLDR-LOAD.exitCode} != 0 && ${SQLLDR-LOAD.exitCode} != 2]]></failureCondition>
						<failureMessage>SQLLDR-(${SQLLDR-LOAD.exitCode}) :Error while loading '${GET-FILE-DATA.P_DATA_FILE_O}' file. See SQLLoader log for details.</failureMessage>
					</stageFailure>
					<execDefinition>
						<sqlLoader>
							<controlFileUri>[@WARN_DISC:2][@WARN_REJ:0]${CONTROL-PATH}/${GET-FILE-DATA.P_CTRL_FILE_O}</controlFileUri>
							<dataFileUri>${PROCESSING-SOURCE-PATH}/${GET-FILE-DATA.P_DATA_FILE_O}</dataFileUri>
							<discardFileUri>${DISCARD-PATH}/${GET-FILE-DATA.P_DISCARD_FILE_O}</discardFileUri>
							<rejectFileUri>${REJECT-PATH}/${GET-FILE-DATA.P_REJECT_FILE_O}</rejectFileUri>
							<logFileUri>${LOG-PATH}/${GET-FILE-DATA.P_LOG_FILE_O}</logFileUri>
							<exitCodeProperty>exitCode</exitCodeProperty>
							<numberOfRejectedRowsProperty>numberOfRejectedRows</numberOfRejectedRowsProperty>
							<numberOfDiscardedRowsProperty>numberOfDiscardedRows</numberOfDiscardedRowsProperty>
						</sqlLoader>
					</execDefinition>
				</stage>
				<stage enabled="true" id="DATA-QUALITY-CHECK-RECORD" name="DATA-QUALITY-CHECK-RECORD">
                    <description>DATA-QUALITY-CHECK-RECORD</description>
                    <stageFailure>
                        <failureCondition><![CDATA[${GET-ROW-COUNT.totalNoOfRows} > 2 && ${GET-ROW-COUNT.totalNoOfRows} == ${SQLLDR-LOAD.numberOfDiscardedRows} ]]></failureCondition>
                        <failureMessage>All records rejected/discarded in file (${SOURCE-FILE}). Please contact Source system.</failureMessage>
                    </stageFailure>
                    <execDefinition>
                        <noOpExecDefinition>
                            <input>OK</input>
                            <numberOfTasks>1</numberOfTasks>
                            <numberOfInterimStatusResponses>1</numberOfInterimStatusResponses>
                            <durationBetweenEventsInMs>250</durationBetweenEventsInMs>
                            <outputPropertyName>output</outputPropertyName>
                        </noOpExecDefinition>
                    </execDefinition>
                </stage>
				<stage name="HANDLE-REJECTED-RECORDS" id="BAD-FILE-HANDLER">
					<description>Prepares rejected records for processing</description>
					<skipCondition><![CDATA[${SQLLDR-LOAD.numberOfRejectedRows} == 0]]></skipCondition>
					<execDefinition>
						<javaExtension>
							<javaExtensionExecutorClassName>com.bns.ctr.maestro.javaexec.BadFileHandlerExec</javaExtensionExecutorClassName>
							<simpleProperties>
								<properties>
									<simpleProperty name="rejectXMLFileName">${GET-FILE-DATA.P_REJ_XML_FILE_O}</simpleProperty>
									<simpleProperty name="rejectFileName">${GET-FILE-DATA.P_REJECT_FILE_O}</simpleProperty>
									<simpleProperty name="delimiterName">${DELIMITER}</simpleProperty>
								</properties>
							</simpleProperties>
							<javaExtensionOutputPropertyNames>
								<propertyName>fixedFileName</propertyName>
								<propertyName>badFileName</propertyName>
							</javaExtensionOutputPropertyNames>
							<outputPropertyMapping>
								<mapping source="fixedFileName" target="#fixedFileName"/>
								<mapping source="badFileName" target="#badFileName"/>
							</outputPropertyMapping>
						</javaExtension>
					</execDefinition>
				</stage>
				<stage name="SQLLOADER-LOAD-FIXED-FILE" id="SQLLDR-LOAD-FIXED">
					<description>Loads fixed source file</description>
					<skipCondition><![CDATA[${SQLLDR-LOAD.numberOfRejectedRows} == 0 || '${#fixedFileName}' == 'NONE' ]]></skipCondition>
					<stageFailure>
						<failureCondition><![CDATA[${SQLLDR-LOAD-FIXED.exitCode} != 0 && ${SQLLDR-LOAD-FIXED.exitCode} != 2]]></failureCondition>
						<failureMessage>SQLLDR-(${SQLLDR-LOAD-FIXED.exitCode}) :Error while loading '${#fixedFileName}' file. See SQLLoader log for details.</failureMessage>
					</stageFailure>
					<execDefinition>
						<sqlLoader>
							<controlFileUri>${CONTROL-PATH}/${GET-FILE-DATA.P_CTRL_FILE_O}</controlFileUri>
							<dataFileUri>${#fixedFileName}</dataFileUri>
							<discardFileUri>${DISCARD-PATH}/${GET-FILE-DATA.P_DISCARD_FILE_O}.handler.fix</discardFileUri>
							<rejectFileUri>${REJECT-PATH}/${GET-FILE-DATA.P_REJECT_FILE_O}.handler.fix</rejectFileUri>
							<logFileUri>${LOG-PATH}/${GET-FILE-DATA.P_LOG_FILE_O}.handler.fix</logFileUri>
							<exitCodeProperty>exitCode</exitCodeProperty>
							<numberOfRejectedRowsProperty>numberOfRejectedRows</numberOfRejectedRowsProperty>
							<numberOfDiscardedRowsProperty>numberOfDiscardedRows</numberOfDiscardedRowsProperty>
						</sqlLoader>
					</execDefinition>
				</stage>
				<stage name="PREPARE-REJECTED-CTRL-FILE" id="PREPARE-REJ-CTRL-FILE">
					<description>Prepare the sqlldr ctrl file for rejected records - substitubes source system code token</description>
					<skipCondition><![CDATA[${SQLLDR-LOAD.numberOfRejectedRows} == 0 || '${#fixedFileName}' == 'NONE' ]]></skipCondition>
					<stageFailure>
						<failureCondition>${PREPARE-REJ-CTRL-FILE.exitCode} != 0</failureCondition>
						<failureMessage>CTL-FILE-TOKEN-HANDLER-(${PREPARE-REJ-CTRL-FILE.exitCode}) 
							:Error while preparing control file. See ctrCTLfileTokenHandler log for details.</failureMessage>
					</stageFailure>
					<execDefinition>
						<callExternalProcess>
							<commandLine>${CTR_APP_ROOT_PATH}/script/ctrCTLfileTokenHandler.${SHELL_SCRIPT_EXTENSION} ${CONTROL-PATH}/${GET-FILE-DATA.P_BAD_CTRL_FILE_TEMPLATE_O} ${CONTROL-PATH}/${GET-FILE-DATA.P_BAD_CTRL_FILE_O} ${SOURCE-SYSTEM} ${GET-FILE-VERSION.originalFileVersion}</commandLine>
							<workingDirectory>${CTR_APP_ROOT_PATH}/script/</workingDirectory>
							<exitCodeProperty>exitCode</exitCodeProperty>
						</callExternalProcess>
					</execDefinition>
				</stage>
				<stage name="SQLLOADER-LOAD-REJECTED-FILE" id="SQLLDR-LOAD-REJECTED">
					<description>Loads source file</description>
					<skipCondition><![CDATA[${SQLLDR-LOAD.numberOfRejectedRows} == 0 || '${#fixedFileName}' == 'NONE' ]]></skipCondition>
					<stageFailure>
						<failureCondition><![CDATA[${SQLLDR-LOAD-REJECTED.exitCode} != 0 && ${SQLLDR-LOAD-REJECTED.exitCode} != 2]]></failureCondition>
						<failureMessage>SQLLDR-(${SQLLDR-LOAD-REJECTED.exitCode}) :Error while loading '${#badFileName}' file. See SQLLoader log for details.</failureMessage>
					</stageFailure>
					<execDefinition>
						<sqlLoader>
							<controlFileUri>${CONTROL-PATH}/${GET-FILE-DATA.P_BAD_CTRL_FILE_O}</controlFileUri>
							<dataFileUri>${#badFileName}</dataFileUri>
							<discardFileUri>${DISCARD-PATH}/${GET-FILE-DATA.P_DISCARD_FILE_O}.handler.bad</discardFileUri>
							<rejectFileUri>${REJECT-PATH}/${GET-FILE-DATA.P_REJECT_FILE_O}.handler.bad</rejectFileUri>
							<logFileUri>${LOG-PATH}/${GET-FILE-DATA.P_LOG_FILE_O}.handler.bad</logFileUri>
							<exitCodeProperty>exitCode</exitCodeProperty>
							<numberOfRejectedRowsProperty>numberOfRejectedRows</numberOfRejectedRowsProperty>
							<numberOfDiscardedRowsProperty>numberOfDiscardedRows</numberOfDiscardedRowsProperty>
						</sqlLoader>
					</execDefinition>
				</stage>
				<stage name="REBUILD-INDEX" id="REBUILD-INDEX">
					<description>Rebuild index for landing table</description>
					<skipCondition><![CDATA['${SOURCE-SYSTEM}' == 'CSM']]></skipCondition>
					<execDefinition>
						<dbProcedure name="CTRMSO.REBUILD_INDEX_SP">
							<in>
								<param name="P_TABLE_NAME_LIST_I" type="STRING">${#LANDING-TABLE-LIST}</param>
								<param name="P_SOURCE_SYSTEM_CD_I" type="STRING">${SOURCE-SYSTEM}</param>
							</in>
						</dbProcedure>
					</execDefinition>
				</stage>
				<stage name="UPDATE-FILE-ID-RECORD" id="UPDATE-FILE">
					<description>Updates the file ID record for the preprocessor</description>
					<skipCondition><![CDATA[${SQLLDR-LOAD.numberOfRejectedRows} != 0]]></skipCondition>
					<execDefinition>
						<dbProcedure name="CTRMSO.FILE_PKG.UPDATE_FILE_SP">
							<in>
								<param name="P_DW_FILE_ID_I" type="NUMBER">${GET-FILE-ID.P_DW_FILE_ID_O}</param>
								<param name="P_BAD_CNT_I" type="NUMBER">${SQLLDR-LOAD.numberOfRejectedRows}</param>
								<param name="P_DISCARD_CNT_I" type="NUMBER">${SQLLDR-LOAD.numberOfDiscardedRows}</param>
							</in>
						</dbProcedure>
					</execDefinition>
				</stage>
				<stage name="UPDATE-FILE-ID-FIXED-RECORD" id="UPDATE-FIXED-FILE">
					<description>Updates the file ID record for the preprocessor</description>
					<skipCondition><![CDATA[${SQLLDR-LOAD.numberOfRejectedRows} == 0 || '${#fixedFileName}' == 'NONE' ]]></skipCondition>
					<execDefinition>
						<dbProcedure name="CTRMSO.FILE_PKG.UPDATE_FILE_SP">
							<in>
								<param name="P_DW_FILE_ID_I" type="NUMBER">${GET-FILE-ID.P_DW_FILE_ID_O}</param>
								<param name="P_BAD_CNT_I" type="NUMBER">${SQLLDR-LOAD-FIXED.numberOfRejectedRows}</param>
								<param name="P_DISCARD_CNT_I" type="NUMBER">${SQLLDR-LOAD.numberOfDiscardedRows}</param>
							</in>
						</dbProcedure>
					</execDefinition>
				</stage>
				<stage name="LOANS-PRE-LANDING-FOR-ACBS-LO-ONLY" id="LOANS-PRE-LANDING-ACBS">
					<description>Conditionally moves ACBS loan/payschedule from ACBS_LOAN_PAYSCHEDULE_L to ACBS_L</description>
					<skipCondition><![CDATA['${SOURCE-SYSTEM}' != 'ACBS' || '${GET-FILE-DATA.P_SUBJECT_AREA_O}' != 'LO']]></skipCondition>
					<execDefinition>
						<dbProcedure name="CTRMSO.ETL_INVOKER_SP">
							<in>
								<param name="P_TYPE_NAME_I" type="STRING">arrangement_loan_tp</param>
								<param name="P_METHOD_NAME_I" type="STRING">pub_move_pre_landing</param>
								<param name="P_RUN_ID_I" type="NUMBER">${RUN-ID}</param>
								<param name="P_STAGE_ID_I" type="STRING">LANDING</param>
								<param name="P_TASK_ID_I" type="STRING">LOANS-PRE-LANDING-ACBS</param>
								<param name="P_LOG_ID_I" type="STRING">1</param>
								<param name="P_BUSINESS_DATE_I" type="STRING">${BUSINESS-DATE}</param>
								<param name="P_SOURCE_SYSTEM_CD_I" type="STRING">${SOURCE-SYSTEM}</param>
							</in>
							<out>
								<param name="P_RET_VALUE_O" type="NUMBER"></param>
								<param name="P_RET_MESSAGE_O" type="STRING"></param>
							</out>
						</dbProcedure>
					</execDefinition>
				</stage>
			</sequential>
		</parallel>
		<parallel name="HANDLE-EMPTY-FILE" id="HANDLE-EMPTY-FILE">
			<skipCondition><![CDATA[!('${GET-FILE-VERSION.isHolidayFile}' == 'true' || ( '${GET-FILE-VERSION.headerName}' == 'EMPTY' && '${GET-FILE-DATA.P_HAS_HEADER_O}' == 'Y' ))]]></skipCondition>
			<sequential name="IF-FILE-IS-EMPTY" id="IF-FILE-IS-EMPTY">
				<stage name="GET-EMPTY-FILE-ID" id="GET-EMPTY-FILE-ID">
					<description>Retrieves the file ID for the preprocessor</description>
					<execDefinition>
						<dbProcedure name="CTRMSO.FILE_PKG.CREATE_FILE_SP">
							<in>
								<param name="P_FILENAME_I" type="STRING">${PROCESSING-SOURCE-PATH}/${GET-FILE-DATA.P_DATA_FILE_O}</param>
								<param name="P_ROWCOUNT_I" type="NUMBER">0</param>
								<param name="P_HEADER_VERSION_I" type="STRING">0</param>
								<param name="P_ORIGINAL_HEADER_VERSION_I" type="STRING">0</param>
								<param name="P_SUBJECT_AREA_CD_I" type="STRING">${GET-FILE-DATA.P_SUBJECT_AREA_O}</param>
								<param name="P_RUN_ID_I" type="NUMBER">${RUN-ID}</param>
								<param name="P_STAGE_ID_I" type="STRING">LANDING</param>
								<param name="P_TASK_ID_I" type="STRING">${GET-FILE-DATA.P_SUBJECT_AREA_O}-${GET-FILE-DATA.P_PRODUCT_TYPE_O}-GET-FILE-ID</param>
								<param name="P_LOG_ID_I" type="STRING">1</param>
								<param name="P_SOURCE_SYSTEM_CD_I" type="STRING">${SOURCE-SYSTEM}</param>
								<param name="P_LANDING_TABLE_LIST_I" type="STRING">EMPTY_FILE_NOT_LOADED</param>
								<param name="P_FILE_CREATE_TIME_I" type="STRING">${GET-FILE-CREATE-TIME.fileCreateTime}</param>
							</in>
							<out>
								<param name="P_DW_FILE_ID_O" type="NUMBER"></param>
							</out>
						</dbProcedure>
					</execDefinition>
				</stage>
				<stage name="UPDATE-EMPTY-FILE-ID-RECORD" id="UPDATE-EMPTY-FILE">
					<description>Updates the file ID record for the empty file</description>
					<execDefinition>
						<dbProcedure name="CTRMSO.FILE_PKG.UPDATE_FILE_SP">
							<in>
								<param name="P_DW_FILE_ID_I" type="NUMBER">${GET-EMPTY-FILE-ID.P_DW_FILE_ID_O}</param>
								<param name="P_BAD_CNT_I" type="NUMBER">0</param>
								<param name="P_DISCARD_CNT_I" type="NUMBER">0</param>
							</in>
						</dbProcedure>
					</execDefinition>
				</stage>
			</sequential>
		</parallel>
	</sequential>
</workflow>