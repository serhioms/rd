<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- $Id: CTR-EXTRACT-TO-E2E.xml 3690 2016-06-01 20:44:07Z gmusial $
	 Maestro version: 1.16.0 -->
	 
<workflow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="workflowDefinition.xsd">
	<name>CTR-EXTRACT-TO-E2E</name> 
  	<externalWorkflowCode>CTR-EXTRACT-TO-E2E</externalWorkflowCode> 
  	<finishOrchestrationASAPOnError>false</finishOrchestrationASAPOnError> 
	<description>CTR-EXTRACT-TO-E2E ($LastChangedRevision: 3690 $)</description>

	<properties>
		<inputProperties>
			<property name="RUN-ID" />
			<property name="BUSINESS-DATE" />
			<property name="EOD-EOM-IND" />
		</inputProperties>
	</properties>

	<!-- DELIVERY PHASE -->

	<sequential name="CTR-EXTRACT-TO-E2E" id="CTR-EXTRACT-TO-E2E">
		<parallel id="GENERATE-E2E-FILES" name="GENERATE-E2E-FILES">
			<stage name="GENERATE-ACQUSITION-FILE" id="CTR-ACQ-E2E">
				<description>Generate CTR acqusition file</description>
				<stageFailure>
					<failureCondition><![CDATA[${CTR-ACQ-E2E.exitCode} != 0]]></failureCondition>
					<failureMessage>FSM-(${CTR-ACQ-E2E.exitCode}) : Error while generating CTR acqusition file. See FSM log for details.</failureMessage>
				</stageFailure>
				<execDefinition>
					<callExternalProcess>
						<commandLine>${CTR_APP_ROOT_PATH}/script/extractE2Erpt.${SHELL_SCRIPT_EXTENSION} ${CTR_DB_SCHEMA} Acquisition CTR_${EOD-EOM-IND}_Acquisition_${BUSINESS-DATE}.csv ${SHELL_COMMA_DELIM_PARAM} ${RUN-ID}  CTR_${EOD-EOM-IND}_Acquisition_${BUSINESS-DATE}.csv.mrk</commandLine>

						<workingDirectory>${CTR_APP_ROOT_PATH}/script/</workingDirectory>
						<exitCodeProperty>exitCode</exitCodeProperty>
					</callExternalProcess>
				</execDefinition>
			</stage>
			<stage name="GENERATE-EXTRACT-FILE" id="CTR-EXTRACT-E2E">
				<description>Generate CTR extraction file</description>
				<stageFailure>
					<failureCondition><![CDATA[${CTR-EXTRACT-E2E.exitCode} != 0]]></failureCondition>
					<failureMessage>FSM-(${CTR-EXTRACT-E2E.exitCode}) : Error while generating CTR extract file. See FSM log for details.</failureMessage>
				</stageFailure>
				<execDefinition>
					<callExternalProcess>
						<commandLine>${CTR_APP_ROOT_PATH}/script/extractE2Erpt.${SHELL_SCRIPT_EXTENSION} ${CTR_DB_SCHEMA} Extraction CTR_${EOD-EOM-IND}_Extraction_${BUSINESS-DATE}.csv ${SHELL_COMMA_DELIM_PARAM} ${RUN-ID}  CTR_${EOD-EOM-IND}_Extraction_${BUSINESS-DATE}.csv.mrk</commandLine>
						<workingDirectory>${CTR_APP_ROOT_PATH}/script/</workingDirectory>
						<exitCodeProperty>exitCode</exitCodeProperty>
					</callExternalProcess>
				</execDefinition>
			</stage>
		</parallel>

		<parallel name="SEND-GENERATED-FILES" id="SEND-GENERATED-FILES">
			<stage name="SEND-TO-E2E" id="SEND-TO-E2E">
				<skipCondition>'${E2E_DESTINATION_URI}' == 'NONE'</skipCondition>
				<execDefinition>
					<fileTransfer>
						<transfer>
							<sourceResource>
								<uri>${CTR_OUTBOUND_PATH}/e2e</uri>
								<searchPattern>CTR_${EOD-EOM-IND}_.*_${BUSINESS-DATE}\.(csv|mrk)</searchPattern>
								<matchedUriOutputProperty>E2E-FILES</matchedUriOutputProperty>
							</sourceResource>
							<targetResource>
								<uri>${E2E_DESTINATION_URI}</uri>
							</targetResource>
						</transfer>
						<transferCountProperty>transferCount</transferCountProperty>
					</fileTransfer>
				</execDefinition>
			</stage>
		</parallel>
	</sequential>

</workflow>
	