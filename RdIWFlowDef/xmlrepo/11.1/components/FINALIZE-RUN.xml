<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- $Id: FINALIZE-RUN.xml 3690 2016-06-01 20:44:07Z gmusial $
	 Maestro version: 1.19.1 -->
	 
<workflow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="workflowDefinition.xsd">
	<name>FINALIZE-RUN</name> 
  	<externalWorkflowCode>FINALIZE-RUN</externalWorkflowCode> 
  	<finishOrchestrationASAPOnError>false</finishOrchestrationASAPOnError> 
	<description>FINALIZE-RUN ($LastChangedRevision: 3690 $)</description>

	<properties>
		<inputProperties>
			<property name="SOURCE-SYSTEM" />
			<property name="RUN-ID" />
			<property name="BUSINESS-DATE" />
			<property name="SRC-FILE-SUFFIX-PATTERN" />
			<property name="FTP-SOURCE-DIR" />
		</inputProperties>
		<generalProperties>
			<property name="SRC-FILE-DATEPATTERN">[0-9]{6}</property>
			<property name="CTR-SRC-FILE-PATTERN">egl_mrd</property>
		</generalProperties>
	</properties>

	<sequential name="CLEAN-UP" id="CLEAN-UP">
		<stage name="CLEAN-UP-FTP-DIR" id="CLEAN-UP-FTP-DIR">
			<description>Clean up files in FTP directory</description>
			<skipCondition>'${FTP-SOURCE-DIR}' == 'NONE' || '${SOURCE-SYSTEM}' == 'NONE' || '${SRC-FILE-SUFFIX-PATTERN}' == 'NONE' || '${SOURCE-SYSTEM}' == 'CTR'</skipCondition>
			<execDefinition>
				<deleteResource failOnError="false">
					<resource>
						<uri>${FTP-SOURCE-DIR}</uri>
						<searchPattern>${SOURCE-SYSTEM}_[A-Z]{2,2}_${SRC-FILE-SUFFIX-PATTERN}(.csv|.mrk|.csv.mrk)</searchPattern>
						<matchedUriOutputProperty>matchedFiles</matchedUriOutputProperty>
					</resource>
					<deleteCountProperty>matchedCount</deleteCountProperty>
				</deleteResource>
			</execDefinition>
		</stage>
		<stage id="CLEAN-UP-REF_DATA_FTP-DIR" name="CLEAN-UP-REF_DATA_FTP-DIR">
            <description>Clean up files in FTP directory</description>
            <skipCondition>'${FTP-SOURCE-DIR}' == 'NONE' || '${SOURCE-SYSTEM}' == 'NONE' || '${SOURCE-SYSTEM}' != 'CTR'</skipCondition>
            <stageFailure>
                <failureCondition>${CLEAN-UP-REF_DATA_FTP-DIR.matchedCount} == 0</failureCondition>
                <failureMessage>Error while removing files from '${FTP-SOURCE-DIR}'. FTP files are not cleaned up.</failureMessage>
            </stageFailure>
            <execDefinition>
                <deleteResource failOnError="false">
                    <resource>
                        <uri>${FTP-SOURCE-DIR}</uri>
                        <searchPattern>${CTR-SRC-FILE-PATTERN}_.*_${SRC-FILE-DATEPATTERN}(.csv|.mrk)</searchPattern>
                        <matchedUriOutputProperty>matchedFilesforEGL</matchedUriOutputProperty>
                    </resource>
                    <resource>
                    	<uri>${FTP-SOURCE-DIR}</uri>
						<searchPattern>${SOURCE-SYSTEM}_[A-Z]{2,2}_${SRC-FILE-SUFFIX-PATTERN}(.csv|.mrk|.txt)</searchPattern>
						<matchedUriOutputProperty>matchedFiles</matchedUriOutputProperty>
                    </resource>
                    <deleteCountProperty>matchedCount</deleteCountProperty>
                </deleteResource>
            </execDefinition>
        </stage>
		<stage name="RUN-COMPLETE" id="RUN-COMPLETE">
			<description>Finalize the run and mark complete</description>
			<execDefinition>
				<dbProcedure name="CTRMSO.RUN_COMPLETION_SP">
					<in>
						<param name="P_RUN_ID_I" type="NUMBER">${RUN-ID}</param>
						<param name="P_STAGE_ID_I" type="STRING">FINALIZE</param>
						<param name="P_TASK_ID_I" type="STRING">RUN-COMPLETE</param>
						<param name="P_LOG_ID_I" type="STRING">1</param>
						<param name="P_BUSSINESS_DATE_I" type="STRING">${BUSINESS-DATE}</param>
					</in>
					<out>
						<param name="P_RET_VALUE_O" type="NUMBER"></param>
						<param name="P_RET_MESSAGE_O" type="STRING"></param>
					</out>
				</dbProcedure>
			</execDefinition>
		</stage>
	</sequential>
</workflow>
	